# Feature: Proactive Refactor - Agent Consolidation & Code Quality - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/57d322-proactive-refactor/spec.md
> **Created:** 2025-10-22
> **Run ID:** 57d322
> **Feature:** proactive-refactor

## Execution Summary

- **Total Tasks**: 6
- **Total Phases**: 5
- **Sequential Time**: 22h
- **Parallel Time**: 18h
- **Time Savings**: 4h (18%)

**Parallel Opportunities:**

- Phase 1: 2 tasks running in parallel (4h saved)

**Task Breakdown:**

- M (3-5h): 6 tasks
- L (5-7h): 0 tasks
- S (1-2h): 0 tasks

**Architecture Compliance:**

> **Constitution**: All tasks MUST follow @docs/constitutions/current/
>
> - Layer boundaries: architecture.md
> - Required patterns: patterns.md
> - Schema validation: schema-rules.md
> - Testing standards: testing.md

---

## Phase 1: Foundation (Parallel)

**Strategy**: Parallel execution
**Reason**: Tasks are independent - agent utilities and CLI helpers have no shared files or dependencies
**Phase Time**: 4h (sequential would be 8h)

### Task 1: Agent Utilities Foundation

**Files**:

- `src/agents/agent-utils.ts` (new)
- `src/agents/__tests__/agent-utils.test.ts` (new)

**Complexity**: M (4h)

**Dependencies**: None

**Description**:

Create shared utility functions for agent implementations. Extract common logic for response cleaning, commit message validation, and error detection into pure, stateless functions. This provides the foundation that BaseAgent and all agent implementations will use.

**Implementation Steps**:

1. Create `src/agents/agent-utils.ts` with three pure utility functions:

   - `cleanAIResponse(output: string): string`
     - Remove common AI artifacts (markdown code blocks, thinking tags, etc.)
     - Remove excessive newlines and whitespace
     - Trim output
   - `validateConventionalCommit(message: string): boolean`
     - Basic format check: `type(scope?): description`
     - Return true if valid, false otherwise
   - `isCLINotFoundError(error: unknown): boolean`
     - Type guard to detect ENOENT errors
     - Check error.code === 'ENOENT' safely

2. Add comprehensive unit tests in `src/agents/__tests__/agent-utils.test.ts`:

   - Test `cleanAIResponse()` with various AI artifacts
   - Test `validateConventionalCommit()` with valid/invalid formats
   - Test `isCLINotFoundError()` with different error types
   - Achieve 100% coverage for utility functions

3. Add JSDoc documentation with examples for each function

4. Export utilities from `src/agents/agent-utils.ts`

**Acceptance Criteria**:

- [ ] All three utility functions implemented as pure functions (no state, no side effects)
- [ ] 100% test coverage for agent-utils with comprehensive edge cases
- [ ] JSDoc documentation with examples for each function
- [ ] `pnpm test src/agents/__tests__/agent-utils.test.ts` passes
- [ ] `pnpm run type-check` passes

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/patterns.md for utility function patterns

**TDD**: Use test-driven development:

1. Write test for `cleanAIResponse()` first
2. Watch it fail
3. Implement minimal code to pass
4. Refactor
5. Repeat for other functions

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/agent-utils.test.ts
pnpm run type-check
```

---

### Task 5: CLI Helpers Extraction

**Files**:

- `src/cli/helpers.ts` (new)
- `src/cli/__tests__/helpers.test.ts` (new)
- `src/cli.ts` (modified)

**Complexity**: M (4h)

**Dependencies**: None

**Description**:

Extract display and execution helper functions from `src/cli.ts` into a separate module to improve testability and readability. Reduce `cli.ts` from 265 LOC to ~150 LOC by moving 6-7 helper functions into focused, testable utilities.

**Implementation Steps**:

1. Create `src/cli/helpers.ts` with extracted helper functions:

   - `displayStagedChanges(changes: string): void` - Format and display git changes
   - `displayGenerationStatus(agent: string): void` - Show "Generating with X..." message
   - `displayCommitMessage(message: string): void` - Format and display generated message
   - `executeCommit(message: string, workdir: string): Promise<void>` - Run git commit
   - Extract any other helper functions currently in cli.ts

2. Refactor `src/cli.ts`:

   - Import helper functions from `./helpers.js`
   - Replace inline logic with helper calls
   - Verify LOC reduced from 265 → ~150
   - Maintain identical CLI behavior (backward compatible)

3. Add comprehensive tests in `src/cli/__tests__/helpers.test.ts`:

   - Mock console.log to test display functions
   - Mock execa to test executeCommit
   - Test all display formatting edge cases
   - Test error handling in executeCommit

4. Update existing CLI tests if needed to work with extracted helpers

**Acceptance Criteria**:

- [ ] All helpers extracted to `src/cli/helpers.ts` with clear function signatures
- [ ] `src/cli.ts` reduced from 265 LOC → ~150 LOC
- [ ] 100% test coverage for all helper functions
- [ ] CLI behavior unchanged (backward compatible)
- [ ] `pnpm test src/cli/__tests__/` passes

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/architecture.md for CLI layer boundaries

CLI helpers should:

- Format output for users (not business logic)
- Use chalk for colored output
- Handle process.exit codes properly
- Be easily unit testable

**TDD**: Write tests first for each helper function:

1. Write test for `displayStagedChanges()` with mocked console
2. Watch fail
3. Implement minimal code
4. Refactor for clarity

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/cli/__tests__/
pnpm run type-check
```

---

## Phase 2: Base Agent Template

**Strategy**: Sequential
**Reason**: Depends on Task 1 (agent-utils) - will import and use utility functions
**Phase Time**: 4h

### Task 2: Base Agent Template

**Files**:

- `src/agents/base-agent.ts` (new)
- `src/agents/__tests__/base-agent.test.ts` (new)

**Complexity**: M (4h)

**Dependencies**: Task 1 (uses agent-utils)

**Description**:

Create abstract `BaseAgent` class that implements the `Agent` interface with a template method pattern. Provides standard flow (availability → execute → clean → validate) with three extension points. Keeps agents simple (~40-60 LOC each) while eliminating duplication.

**Implementation Steps**:

1. Create `src/agents/base-agent.ts`:

   - Import `Agent` interface and `agent-utils` functions
   - Define abstract class `BaseAgent implements Agent`
   - Add `readonly abstract name: string`
   - Implement `generate(prompt: string, workdir: string): Promise<string>`:
     - Call `checkAvailability()` (concrete method using execa)
     - Call `executeCommand(prompt, workdir)` (abstract - must override)
     - Call `cleanResponse(output)` (virtual - can override, default uses `cleanAIResponse()`)
     - Call `validateResponse(message)` (virtual - can override, default uses `validateConventionalCommit()`)
     - Return cleaned, validated message
   - Define extension points:
     - `abstract executeCommand(prompt: string, workdir: string): Promise<string>` - REQUIRED
     - `protected cleanResponse(output: string): string` - OPTIONAL (default implementation)
     - `protected validateResponse(message: string): void` - OPTIONAL (default implementation)

2. Add comprehensive tests in `src/agents/__tests__/base-agent.test.ts`:

   - Create concrete `TestAgent` class for testing
   - Test standard flow: availability → execute → clean → validate
   - Test that all hooks are called in correct order
   - Test error handling (CLI not found, execution failed, validation failed)
   - Test that default cleanResponse uses agent-utils
   - Test that default validateResponse uses agent-utils
   - Test that subclasses can override cleanResponse and validateResponse

3. Add JSDoc documentation explaining:
   - Template method pattern
   - Three extension points
   - Example of extending BaseAgent

**Acceptance Criteria**:

- [ ] BaseAgent has exactly 3 extension points (no over-abstraction)
- [ ] Standard flow enforced: checkAvailability → executeCommand → cleanResponse → validateResponse
- [ ] Default implementations use agent-utils functions
- [ ] 100% test coverage with TestAgent mock
- [ ] `pnpm test src/agents/__tests__/base-agent.test.ts` passes

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/architecture.md and patterns.md

BaseAgent must:

- Remain simple (target ~80 LOC)
- Not reintroduce v1 complexity (no factories, no complex inheritance)
- Preserve agent readability (agents should be ~40-60 LOC)
- Use template method pattern, not strategy pattern

**TDD**: Write tests for template flow first:

1. Write test: "should call extension points in order"
2. Watch fail
3. Implement generate() method
4. Watch pass

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/base-agent.test.ts
pnpm run type-check
```

---

## Phase 3: Claude Agent Refactor

**Strategy**: Sequential
**Reason**: Depends on Task 1 (agent-utils) and Task 2 (base-agent) - first concrete implementation validates the pattern
**Phase Time**: 3h

### Task 3: Refactor Claude Agent

**Files**:

- `src/agents/claude.ts` (modified - 219 LOC → ~40 LOC)
- `src/agents/__tests__/claude.test.ts` (modified)
- `src/agents/index.ts` (modified - export BaseAgent)

**Complexity**: M (3h)

**Dependencies**: Task 1 (agent-utils), Task 2 (base-agent)

**Description**:

Refactor ClaudeAgent to extend BaseAgent, reducing from 219 LOC to ~40 LOC. Implement only `executeCommand()` extension point, relying on base class for standard flow. First concrete agent validates that the BaseAgent pattern works correctly.

**Implementation Steps**:

1. Refactor `src/agents/claude.ts`:

   - Import `BaseAgent` from `./base-agent.js`
   - Change `export class ClaudeAgent implements Agent` to `export class ClaudeAgent extends BaseAgent`
   - Remove `generate()` method (inherited from BaseAgent)
   - Keep only `executeCommand()` implementation:
     ```typescript
     protected async executeCommand(prompt: string, workdir: string): Promise<string> {
       const result = await execa('claude', ['--prompt', prompt], {
         cwd: workdir,
         timeout: 120_000
       });
       return result.stdout;
     }
     ```
   - Remove manual response cleaning (now in BaseAgent)
   - Remove manual validation (now in BaseAgent)
   - Verify LOC reduced to ~40

2. Update `src/agents/__tests__/claude.test.ts`:

   - Update tests to work with BaseAgent structure
   - Verify all existing tests still pass
   - Add test that ClaudeAgent uses BaseAgent template flow
   - Mock execa to test executeCommand in isolation

3. Update `src/agents/index.ts`:
   - Export BaseAgent: `export { BaseAgent } from './base-agent.js';`
   - Keep existing exports (ClaudeAgent, CodexAgent, etc.)

**Acceptance Criteria**:

- [ ] ClaudeAgent extends BaseAgent (not implements Agent directly)
- [ ] ClaudeAgent reduced from 219 LOC → ~40 LOC
- [ ] Only executeCommand() implemented (no generate() override)
- [ ] All existing Claude tests pass without modification to test behavior
- [ ] `pnpm test src/agents/__tests__/claude.test.ts` passes

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/architecture.md

Agent refactoring must:

- Preserve backward compatibility (Agent interface unchanged)
- Maintain all error handling (now in BaseAgent)
- Keep agents readable end-to-end (~40-60 LOC)
- No breaking changes to public API

**Verification**:

Before completing, verify:

1. Agent behavior unchanged (run integration tests)
2. Error messages still actionable
3. CLI availability check still works

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/claude.test.ts
pnpm test  # All tests should still pass
pnpm run type-check
```

---

## Phase 4: Codex & ChatGPT Agent Refactor

**Strategy**: Sequential
**Reason**: Depends on Task 1, 2, 3 - follows pattern validated by Claude refactor, shares src/agents/index.ts
**Phase Time**: 4h

### Task 4: Refactor Codex & ChatGPT Agents

**Files**:

- `src/agents/codex.ts` (modified - 255 LOC → ~60 LOC)
- `src/agents/chatgpt.ts` (modified - 210 LOC → ~50 LOC)
- `src/agents/__tests__/codex.test.ts` (modified)
- `src/agents/__tests__/chatgpt.test.ts` (modified)
- `src/agents/index.ts` (modified - ensure all exports)

**Complexity**: M (4h)

**Dependencies**: Task 1 (agent-utils), Task 2 (base-agent), Task 3 (claude - shares index.ts)

**Description**:

Refactor CodexAgent and ChatGPTAgent to extend BaseAgent, following the pattern validated by Claude refactor. Codex will override `cleanResponse()` for Codex-specific artifacts. Both agents reduced to ~50-60 LOC each.

**Implementation Steps**:

1. Refactor `src/agents/codex.ts`:

   - Import `BaseAgent` from `./base-agent.js`
   - Change to `export class CodexAgent extends BaseAgent`
   - Remove `generate()` method
   - Implement `executeCommand()`:
     ```typescript
     protected async executeCommand(prompt: string, workdir: string): Promise<string> {
       const result = await execa('codex', ['exec', prompt], {
         cwd: workdir,
         timeout: 120_000
       });
       return result.stdout;
     }
     ```
   - Override `cleanResponse()` for Codex-specific artifact removal:
     ```typescript
     protected cleanResponse(output: string): string {
       // First apply base cleaning
       let cleaned = super.cleanResponse(output);
       // Then remove Codex-specific artifacts
       cleaned = cleaned.replace(/\[CODEX\]/g, '');
       return cleaned;
     }
     ```
   - Verify LOC reduced to ~60

2. Refactor `src/agents/chatgpt.ts`:

   - Import `BaseAgent` from `./base-agent.js`
   - Change to `export class ChatGPTAgent extends BaseAgent`
   - Remove `generate()` method
   - Implement `executeCommand()`:
     ```typescript
     protected async executeCommand(prompt: string, workdir: string): Promise<string> {
       const result = await execa('chatgpt', ['--prompt', prompt], {
         cwd: workdir,
         timeout: 120_000
       });
       return result.stdout;
     }
     ```
   - Verify LOC reduced to ~50

3. Update tests:

   - Update `src/agents/__tests__/codex.test.ts` for BaseAgent structure
   - Update `src/agents/__tests__/chatgpt.test.ts` for BaseAgent structure
   - Verify all existing tests pass
   - Add tests for Codex's custom cleanResponse override

4. Verify `src/agents/index.ts` exports all agents correctly

**Acceptance Criteria**:

- [ ] CodexAgent extends BaseAgent and reduced to ~60 LOC
- [ ] ChatGPTAgent extends BaseAgent and reduced to ~50 LOC
- [ ] CodexAgent overrides cleanResponse() for Codex-specific cleaning
- [ ] ChatGPTAgent uses default cleanResponse() from BaseAgent
- [ ] All existing tests pass without behavior changes
- [ ] ChatGPT agent kept (needed for eval scorer as per spec)

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/architecture.md

Pattern consistency:

- Both agents follow same structure as Claude
- Only override what's necessary (Codex needs custom cleanResponse)
- Maintain backward compatibility
- No breaking changes

**Verification**:

Test all three agents work end-to-end:

```bash
pnpm test src/agents/__tests__/
```

Verify integration tests still pass:

```bash
pnpm test src/__tests__/integration/
```

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/
pnpm test  # All tests
pnpm run type-check
```

---

## Phase 5: Schema Hardening & Dead Code Cleanup

**Strategy**: Sequential
**Reason**: Depends on Task 3, 4 - agentNameSchema enum requires all agents refactored first
**Phase Time**: 3h

### Task 6: Schema Hardening & Dead Code Cleanup

**Files**:

- `src/types/schemas.ts` (modified)
- `src/utils/git-schemas.ts` (modified)
- All files with stale v1 comments (search and clean)

**Complexity**: M (3h)

**Dependencies**: Task 3 (claude), Task 4 (codex, chatgpt) - enum must match refactored agents

**Description**:

Remove arbitrary schema constraints, add meaningful validation, and clean dead code. Add `agentNameSchema` enum for type safety. Remove `FileCategorization` type alias. Clean all stale v1 comments across codebase.

**Implementation Steps**:

1. Update `src/types/schemas.ts`:

   - Remove arbitrary `.max(200)`, `.max(1000)` constraints
   - Add `agentNameSchema = z.enum(['claude', 'codex', 'chatgpt'])`
   - Keep meaningful validation:
     - `.min(1)` for non-empty strings
     - `.positive()` for positive numbers
     - Enum types for fixed options
   - Make required vs optional explicit with `.default()` or `.optional()`
   - Update any schemas using agent names to use `agentNameSchema`

2. Update `src/utils/git-schemas.ts`:

   - Remove `FileCategorization` type alias
   - Use `FileCategories` type directly everywhere
   - Update all imports/exports

3. Clean stale v1 comments:

   - Search codebase for v1 migration comments:
     ```bash
     grep -r "v1" src/
     grep -r "migration" src/
     grep -r "TODO.*v1" src/
     ```
   - Remove stale comments about v1 architecture
   - Keep comments that explain current v2 design
   - Simplify overly defensive response cleaning patterns (trust modern agents)

4. Update tests for schema changes:
   - Update `src/types/__tests__/schemas.test.ts` for new validation rules
   - Update `src/utils/__tests__/git-schemas.test.ts` for FileCategorization removal
   - Verify agentNameSchema accepts valid agents, rejects invalid

**Acceptance Criteria**:

- [ ] No arbitrary max constraints remain (only meaningful validation)
- [ ] `agentNameSchema` enum added with all three agents
- [ ] `FileCategorization` type alias removed (use `FileCategories` directly)
- [ ] All stale v1 comments removed from codebase
- [ ] Schema tests updated and passing
- [ ] `pnpm test` passes (all tests)

**Mandatory Patterns**:

> **Constitution**: Follow @docs/constitutions/current/schema-rules.md

Schema validation rules:

- Validate at boundaries (CLI, generator construction, git output)
- Use Zod for runtime validation
- Infer types from schemas (`z.infer<typeof schema>`)
- Provide clear error messages

**Verification**:

Search for dead code patterns:

```bash
# Verify no FileCategorization usage
grep -r "FileCategorization" src/

# Verify no v1 comments
grep -r "v1" src/

# Verify agentNameSchema used
grep -r "agentNameSchema" src/
```

Run full test suite:

```bash
pnpm test
pnpm run type-check
pnpm run lint
```

**Quality Gates**:

```bash
pnpm run lint
pnpm test
pnpm run type-check
```

---

## Post-Implementation Verification

After all tasks complete, verify the entire refactor:

**Code Quality**:

```bash
pnpm run lint
pnpm run type-check
pnpm test
```

**Architecture Validation**:

- [ ] Layer boundaries preserved (CLI → Generator → Agent → External)
- [ ] No factories, chains, or auto-detection (v2 principles maintained)
- [ ] BaseAgent is simple template (~80 LOC)
- [ ] Each agent ~40-60 LOC (readable end-to-end)

**Backward Compatibility**:

- [ ] Agent interface unchanged
- [ ] Generator instantiation unchanged (same if/else pattern)
- [ ] All existing tests pass
- [ ] Public APIs unchanged

**Maintainability**:

- [ ] Adding new agent requires ~20-40 LOC (extend BaseAgent, implement executeCommand)
- [ ] Clear template pattern for contributors
- [ ] Well-documented extension points

**Test Coverage**:

```bash
pnpm test --coverage
```

Verify:

- [ ] Overall coverage ≥80%
- [ ] New utilities have 100% coverage
- [ ] All agent tests passing
- [ ] Integration tests passing

**Documentation**:

- [ ] BaseAgent has JSDoc with extension point examples
- [ ] Agent-utils functions documented
- [ ] CLI helpers documented

**Code Size Validation**:

Check LOC reduction achieved:

```bash
# Before (per spec):
# - Agents: 684 LOC total (Claude 219 + Codex 255 + ChatGPT 210)
# - CLI: 265 LOC

# After (target):
# - Agents: ~150 LOC total (~40-60 each)
# - CLI: ~150 LOC
# - New: BaseAgent ~80 LOC, agent-utils ~100 LOC, cli/helpers ~80 LOC

# Net reduction: ~140 LOC
```

---

## Execution Guide

**Sequential execution** (22h total):

```bash
# Phase 1 - Sequential (8h)
# Task 1: Agent Utilities (4h)
# Task 5: CLI Helpers (4h)

# Phase 2 (4h)
# Task 2: Base Agent (4h)

# Phase 3 (3h)
# Task 3: Claude Refactor (3h)

# Phase 4 (4h)
# Task 4: Codex & ChatGPT Refactor (4h)

# Phase 5 (3h)
# Task 6: Schema Cleanup (3h)
```

**Parallel execution** (18h total - recommended):

```bash
# Phase 1 - PARALLEL (4h) - Run simultaneously:
#   - Task 1: Agent Utilities (4h)
#   - Task 5: CLI Helpers (4h)

# Phase 2 (4h)
# Task 2: Base Agent (4h)

# Phase 3 (3h)
# Task 3: Claude Refactor (3h)

# Phase 4 (4h)
# Task 4: Codex & ChatGPT Refactor (4h)

# Phase 5 (3h)
# Task 6: Schema Cleanup (3h)
```

**git-spice workflow**:

```bash
# Create stack base
gs bc 57d322-agent-utilities
# Implement Task 1, commit

gs bc 57d322-cli-helpers
# Implement Task 5, commit
# (Run in parallel with Task 1)

gs bc 57d322-base-agent
# Implement Task 2, commit

gs bc 57d322-claude-refactor
# Implement Task 3, commit

gs bc 57d322-codex-chatgpt-refactor
# Implement Task 4, commit

gs bc 57d322-schema-cleanup
# Implement Task 6, commit

# Submit entire stack
gs stack submit
```

**Using /spectacular:execute**:

```bash
# Auto-orchestrates phases with parallel execution
/spectacular:execute @specs/57d322-proactive-refactor/plan.md
```

---

## Risk Mitigation

**Low risk refactor** - backward compatible with comprehensive tests:

1. **All existing tests remain valid** (Agent interface unchanged)
2. **Gradual rollout possible** (convert agents one at a time)
3. **Easy rollback** (git revert each task independently)
4. **No external API changes** (internal refactoring only)

**If issues arise**:

- Each task is independently testable
- Each phase can be reviewed before proceeding
- Rollback individual commits if needed
- Constitution compliance ensures quality

---

## References

- **Spec**: specs/57d322-proactive-refactor/spec.md
- **Constitution**: @docs/constitutions/current/
  - architecture.md - Layer boundaries
  - patterns.md - Design patterns
  - schema-rules.md - Validation rules
  - testing.md - Test requirements
- **Dependencies**: Zod, Vitest, execa (no new packages)
