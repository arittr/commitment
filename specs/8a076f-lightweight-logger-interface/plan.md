---
runId: 8a076f
feature: lightweight-logger-interface
created: 2025-11-03
status: ready
---

# Feature: Lightweight Logger Interface - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/8a076f-lightweight-logger-interface/spec.md
> **Created:** 2025-11-03

## Execution Summary

- **Total Tasks**: 4
- **Total Phases**: 3
- **Sequential Time**: 19h
- **Parallel Time**: 13h
- **Time Savings**: 6h (32% faster)

**Parallel Opportunities:**

- Phase 2: 3 tasks (6h saved)

**Task Complexity Distribution:**
- L (5-7h): 2 tasks
- M (3-5h): 2 tasks
- S (1-2h): 0 tasks

---

## Phase 1: Logger Foundation

**Strategy**: Sequential (foundation layer)
**Reason**: All other tasks depend on Logger interface and implementations

### Task 1: Logger Interface and Implementations

**Files**:
- `src/utils/logger.ts` (new)
- `src/utils/__tests__/logger.test.ts` (new)
- `src/utils/index.ts` (export)

**Complexity**: M (3-4h)

**Dependencies**: None

**Description**:
Create lightweight Logger interface (~50 LOC) with ConsoleLogger and SilentLogger implementations. This is the foundation that all other tasks depend on.

**Implementation Steps**:

1. Create `src/utils/logger.ts`:
   - Define `Logger` interface with 4 methods: `debug()`, `info()`, `warn()`, `error()`
   - Implement `ConsoleLogger` class using chalk:
     - `debug()` → `console.log(chalk.gray(message))`
     - `info()` → `console.log(message)`
     - `warn()` → `console.warn(chalk.yellow(message))`
     - `error()` → `console.error(chalk.red(message))`
   - Implement `SilentLogger` class with all no-op methods
   - Export all types and implementations

2. Add barrel export to `src/utils/index.ts`:
   - Export `{ Logger, ConsoleLogger, SilentLogger }` from `./logger.js`

3. Create comprehensive tests in `src/utils/__tests__/logger.test.ts`:
   - Test ConsoleLogger methods call appropriate console methods with correct colors
   - Test SilentLogger methods are all no-ops
   - Test Logger interface is implemented correctly by both classes

**Acceptance Criteria**:

- [ ] Logger interface defined with `debug()`, `info()`, `warn()`, `error()` methods
- [ ] ConsoleLogger implementation with chalk formatting
- [ ] SilentLogger implementation (all no-ops)
- [ ] Implementation is ≤50 LOC (excluding tests)
- [ ] All tests pass
- [ ] No breaking changes to existing code

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md for layer boundaries (Utils module, pure functions).
See patterns.md for dependency injection patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass).

**Quality Gates**:

```bash
bun run lint:fix
bun test src/utils/__tests__/logger.test.ts
```

---

## Phase 2: Logger Integration (Parallel)

**Strategy**: Parallel (independent subsystems)
**Reason**: Each task integrates logger into a different subsystem with no file overlaps

### Task 2: Generator and Agent Layer Integration

**Files**:
- `src/generator.ts`
- `src/agents/types.ts`
- `src/agents/base-agent.ts`
- `src/agents/claude.ts`
- `src/agents/codex.ts`
- `src/agents/gemini.ts`
- `src/agents/__tests__/base-agent.test.ts`
- `src/generator.test.ts` (if exists)

**Complexity**: L (5-6h)

**Dependencies**: Task 1 (requires Logger interface)

**Description**:
Integrate logger into Generator and Agent layers. Update `CommitMessageGeneratorConfig.logger` type from `{ warn }` to `Logger` (backward compatible since Logger includes `warn()`). Update BaseAgent to accept optional logger and pass to subclasses.

**Implementation Steps**:

1. Update `src/agents/types.ts`:
   - Import `Logger` from `../utils/logger.js`
   - Add optional `logger?: Logger` field to Agent interface

2. Update `src/agents/base-agent.ts`:
   - Add `protected logger?: Logger` property
   - Accept `logger?: Logger` in constructor
   - Replace any console.* calls with `logger?.debug()`, `logger?.info()`, `logger?.warn()`, `logger?.error()`
   - Update all agent implementations (claude.ts, codex.ts, gemini.ts) to pass logger to super()

3. Update `src/generator.ts`:
   - Import `Logger` from `./utils/logger.js`
   - Change `CommitMessageGeneratorConfig.logger` type from `{ warn: (message: string) => void }` to `logger?: Logger`
   - Pass logger to agent instances via factory or constructor
   - Replace any console.* calls in generator with logger methods

4. Update tests:
   - Use SilentLogger in all agent tests
   - Use SilentLogger in generator tests
   - Add tests for logger propagation (generator → agent)

**Acceptance Criteria**:

- [ ] Generator accepts `Logger` instead of `{ warn }`
- [ ] BaseAgent accepts optional logger in constructor
- [ ] All agent implementations inherit logger from BaseAgent
- [ ] All console.* calls replaced with logger.* in library code
- [ ] Backward compatible (existing `logger.warn()` calls work)
- [ ] All tests pass with SilentLogger
- [ ] No breaking changes to public API

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md:Generator Layer, Agent Layer boundaries.
See patterns.md:Dependency Injection pattern.

**TDD**: Follow `test-driven-development` skill.

**Quality Gates**:

```bash
bun run lint:fix
bun test src/agents/__tests__/
bun test src/generator.test.ts
```

---

### Task 3: CLI Layer Integration

**Files**:
- `src/cli.ts`
- `src/cli/helpers.ts`
- `src/cli/schemas.ts` (if quiet flag needs schema update)
- `src/cli/commands/init.ts`
- `src/cli/__tests__/cli.test.ts` (if exists)
- `src/cli/__tests__/helpers.test.ts` (if exists)

**Complexity**: M (4-5h)

**Dependencies**: Task 1 (requires Logger interface)

**Description**:
Integrate logger into CLI layer. Create logger based on `--quiet` flag (SilentLogger if quiet, ConsoleLogger otherwise). Pass logger to Generator, CLI helpers, and init command. Keep console.log for critical stdout output (final commit messages).

**Implementation Steps**:

1. Update `src/cli.ts`:
   - Import `{ ConsoleLogger, SilentLogger }` from `./utils/logger.js`
   - Create logger at CLI entry point: `const logger = options.quiet ? new SilentLogger() : new ConsoleLogger();`
   - Pass logger to `CommitMessageGenerator` constructor via config
   - Pass logger to CLI helper functions (displayStagedChanges, displayCommitMessage, etc.)
   - Keep console.log for critical output (stdout commit message for --message-only)
   - Replace progress/informational console.* with logger.*

2. Update `src/cli/helpers.ts`:
   - Import `Logger` from `../utils/logger.js`
   - Add `logger: Logger` parameter to all display functions:
     - `displayStagedChanges(gitStatus: GitStatus, logger: Logger)`
     - `displayCommitMessage(message: string, logger: Logger)`
     - Any other helper functions with console output
   - Replace console.* calls with logger.* (respects --quiet)
   - Keep console.log only for final commit message output

3. Update `src/cli/commands/init.ts`:
   - Import `Logger` from `../../utils/logger.js`
   - Add `logger: Logger` parameter to `initCommand(options, logger)`
   - Replace console.* calls with logger.* for progress messages

4. Update tests:
   - Use SilentLogger in all CLI tests to suppress output
   - Test that --quiet flag creates SilentLogger
   - Test that normal mode creates ConsoleLogger

**Acceptance Criteria**:

- [ ] CLI creates logger based on `--quiet` flag
- [ ] Logger passed to Generator via config
- [ ] Logger passed to CLI helpers and init command
- [ ] Progress/informational output uses logger (respects --quiet)
- [ ] Critical stdout output (commit messages) still uses console.log
- [ ] All tests pass with SilentLogger
- [ ] --quiet flag suppresses progress output

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md:CLI Layer boundaries.
See patterns.md:Dependency Injection pattern.

**TDD**: Follow `test-driven-development` skill.

**Quality Gates**:

```bash
bun run lint:fix
bun test src/cli/__tests__/
```

---

### Task 4: Eval System Integration

**Files**:
- `src/eval/run-eval.ts`
- `src/eval/runners/eval-runner.ts`
- `src/eval/runners/attempt-runner.ts`
- `src/eval/evaluators/chatgpt-evaluator.ts`
- `src/eval/evaluators/codex-evaluator.ts`
- `src/eval/__tests__/` (various test files)

**Complexity**: M (3-4h)

**Dependencies**: Task 1 (requires Logger interface)

**Description**:
Integrate logger into eval system. Create logger in run-eval.ts and pass to runners and evaluators. Replace console.* calls with logger.* for progress/informational output. Keep console.log for final results.

**Implementation Steps**:

1. Update `src/eval/run-eval.ts`:
   - Import `{ ConsoleLogger, SilentLogger }` from `../utils/logger.js`
   - Create logger (always ConsoleLogger for eval since it's a standalone script)
   - Pass logger to runner constructors

2. Update `src/eval/runners/eval-runner.ts`:
   - Import `Logger` from `../../utils/logger.js`
   - Add `logger: Logger` property
   - Accept logger in constructor
   - Replace console.* with logger.* for progress messages
   - Pass logger to attempt runners

3. Update `src/eval/runners/attempt-runner.ts`:
   - Import `Logger` from `../../utils/logger.js`
   - Add `logger: Logger` property
   - Accept logger in constructor
   - Replace console.* with logger.*

4. Update evaluator files:
   - `src/eval/evaluators/chatgpt-evaluator.ts`
   - `src/eval/evaluators/codex-evaluator.ts`
   - Import `Logger` and add logger parameter to constructors
   - Replace console.* with logger.*

5. Update tests:
   - Use SilentLogger in all eval tests
   - Test logger propagation through eval system

**Acceptance Criteria**:

- [ ] Eval system uses logger consistently
- [ ] Logger passed through: run-eval → runner → attempt-runner → evaluators
- [ ] All console.* replaced with logger.* in eval code
- [ ] Final results still use console.log
- [ ] All eval tests pass with SilentLogger
- [ ] No breaking changes to eval system

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md for eval system organization.
See patterns.md:Dependency Injection pattern.

**TDD**: Follow `test-driven-development` skill.

**Quality Gates**:

```bash
bun run lint:fix
bun test src/eval/__tests__/
```

---

## Phase 3: Hook Bug Fix

**Strategy**: Sequential (final integration)
**Reason**: Hook fix depends on CLI integration being complete

### Task 5: Fix lefthook.yml Hook Bug

**Files**:
- `lefthook.yml`
- `examples/lefthook/lefthook.yml` (if exists)

**Complexity**: L (2-3h including testing)

**Dependencies**: Task 3 (CLI must be ready to test hook behavior)

**Description**:
Fix lefthook.yml to check `{2}` parameter before running commitment. This prevents commitment from overwriting user-provided commit messages (git commit -m, merge commits, etc.). Only lefthook.yml needs fixing - plain git hooks, husky, and simple-git-hooks already have correct logic.

**Implementation Steps**:

1. Update `lefthook.yml`:
   - Find the `prepare-commit-msg` hook configuration (around line 18)
   - Change from: `run: ./dist/cli.js --message-only > {1}`
   - To: `run: '[ -z "{2}" ] && ./dist/cli.js --message-only > {1} || true'`
   - This checks if `{2}` (commit source) is empty before running commitment

2. Update example hooks if they exist:
   - Check `examples/lefthook/lefthook.yml`
   - Apply same fix if present

3. Test hook behavior:
   - Test `git commit` (empty `{2}`) → should generate message ✅
   - Test `git commit -m "test"` (`{2}` = "message") → should preserve message ✅
   - Test merge commit (`{2}` = "merge") → should preserve message ✅
   - Verify commitment itself still works (dogfooding test)

4. Document the fix:
   - Verify architecture.md:Hook Preservation Logic is accurate
   - Ensure init.ts hook templates already have correct logic (only lefthook.yml needed fixing)

**Acceptance Criteria**:

- [ ] lefthook.yml checks `{2}` parameter before running commitment
- [ ] `git commit` generates message (hook runs)
- [ ] `git commit -m "test"` preserves message (hook skips)
- [ ] Merge commits preserve messages (hook skips)
- [ ] commitment dogfooding still works
- [ ] Plain git hooks, husky, simple-git-hooks unaffected (already correct)
- [ ] Examples updated if they exist

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md:Hook Preservation Logic.
See architecture.md:Cross-Platform Architecture.

**Testing**:

Manual testing required for git hook behavior:

```bash
# Test 1: git commit (should generate)
git add .
git commit
# Should run commitment and generate message

# Test 2: git commit -m (should preserve)
git add .
git commit -m "test: manual message"
# Should preserve "test: manual message"

# Test 3: merge commit (should preserve)
git merge some-branch
# Should preserve merge commit message

# Test 4: dogfooding
git add .
./dist/cli.js
# Should still work for development
```

**Quality Gates**:

```bash
bun run lint:fix
# Manual hook testing (see above)
```

---

## Implementation Notes

### Constitution References

All tasks MUST follow @docs/constitutions/current/:

- **architecture.md**: Layer boundaries, dependency flow, module organization
- **patterns.md**: Dependency injection, pure functions, type safety
- **schema-rules.md**: No schemas needed (simple TypeScript interface)
- **tech-stack.md**: chalk (already approved)
- **testing.md**: Test isolation with SilentLogger

### Execution Strategy

**Phase 1** (Sequential): Must complete first
- Task 1 creates Logger foundation (all other tasks depend on this)

**Phase 2** (Parallel): Can run simultaneously
- Task 2: Generator/Agent layer (6h)
- Task 3: CLI layer (5h)
- Task 4: Eval system (4h)
- **Time savings**: 6h (sequential 15h → parallel 6h)

**Phase 3** (Sequential): Depends on CLI
- Task 5: Hook fix needs CLI integration complete for testing

### Quality Standards

**Every task must:**
- Follow TDD (write test first, watch fail, implement, watch pass)
- Run `bun run lint:fix` before completion
- Pass all tests with SilentLogger
- Maintain backward compatibility
- Respect architectural layer boundaries

**No breaking changes:**
- Generator config extends `{ warn }` to `Logger` (backward compatible)
- CLI keeps console.log for critical stdout output
- Hook fix only improves behavior (preserves user messages)

### Migration Path

**Library code** (Generator, Agents, Utils, Eval):
- Replace console.* with logger.*
- Accept logger via dependency injection

**CLI code**:
- Create logger based on --quiet flag
- Keep console.log for critical output (stdout commit messages)
- Use logger.* for progress/informational output

**Tests**:
- Use SilentLogger to suppress output
- Tests remain silent by default

### Time Estimates

**Sequential execution**: 19h total
**Parallel execution**: 13h total (Phase 1: 4h + Phase 2: 6h + Phase 3: 3h)
**Time savings**: 6h (32% faster)

---

## Verification Checklist

After all tasks complete:

- [ ] Logger interface defined with 4 methods
- [ ] ConsoleLogger and SilentLogger implementations
- [ ] Implementation ≤50 LOC
- [ ] Generator accepts Logger (backward compatible)
- [ ] BaseAgent accepts optional logger
- [ ] CLI creates logger based on --quiet flag
- [ ] CLI helpers accept logger parameter
- [ ] Eval system uses logger
- [ ] All direct console.* calls replaced in library code
- [ ] CLI files keep console.* for critical output (stdout commit messages)
- [ ] lefthook.yml fixed to check `{2}` parameter
- [ ] All tests pass with SilentLogger
- [ ] --quiet flag suppresses progress output
- [ ] Linting passes
- [ ] No breaking changes to public API
- [ ] `git commit` generates message (hook runs)
- [ ] `git commit -m "test"` preserves message (hook skips)
- [ ] Merge commits preserve messages (hook skips)
