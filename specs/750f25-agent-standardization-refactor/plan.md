---
runId: 750f25
feature: agent-standardization-refactor
created: 2025-11-03
status: ready
---

# Feature: Agent Standardization and Architecture Refactoring - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/750f25-agent-standardization-refactor/spec.md
> **Created:** 2025-11-03

## Execution Summary

- **Total Tasks**: 4
- **Total Phases**: 2
- **Sequential Time**: 17h
- **Parallel Time**: 14h
- **Time Savings**: 3h (18% faster)

**Parallel Opportunities:**

- Phase 1: 2 tasks (3h saved)

---

## Phase 1: Core Refactoring (Parallel)

**Strategy**: parallel
**Reason**: Independent tasks - prompt extraction and Codex agent refactor share no files

### Task 1: Extract Prompt Module

**Files**:

- src/prompts/commit-message-prompt.ts (create)
- src/prompts/__tests__/commit-message-prompt.test.ts (create)
- src/prompts/index.ts (create)
- src/generator.ts (modify)

**Complexity**: M (4h)

**Dependencies**: None

**Description**:
Extract prompt generation logic from generator.ts into a dedicated, testable prompts module. This creates a clean separation between business logic (generator) and prompt construction. The prompt module will be pure functions that take git context and return formatted prompts.

**Implementation Steps**:

1. Create `src/prompts/` directory
2. Extract prompt building logic from `generator.ts` lines 216-261 to `src/prompts/commit-message-prompt.ts`:
   - Create `buildCommitMessagePrompt(context)` function that takes task, git diffs, files, and output
   - Make it a pure function (no side effects, testable)
   - Include proper JSDoc comments
3. Extract `_analyzeCodeChanges()` method from generator to `src/prompts/commit-message-prompt.ts`:
   - Rename to `analyzeCodeChanges(diff, files)` (remove leading underscore - now public API)
   - Keep as pure function
   - Add JSDoc with examples
4. Create barrel export `src/prompts/index.ts`:
   - Export `buildCommitMessagePrompt`
   - Export `analyzeCodeChanges`
5. Update `src/generator.ts`:
   - Import `buildCommitMessagePrompt` from prompts module
   - Replace inline prompt construction (lines 216-261) with call to `buildCommitMessagePrompt()`
   - Pass context object: `{ task, gitDiffStat, gitDiffNameStatus, gitDiffContent, files, output }`
   - Remove `_analyzeCodeChanges()` method (moved to prompts)
6. Create comprehensive tests `src/prompts/__tests__/commit-message-prompt.test.ts`:
   - Test prompt structure and formatting
   - Test diff truncation logic (>8000 chars)
   - Test context inclusion (task, files, output)
   - Test edge cases (empty diff, missing files, no output)
   - Test analyzeCodeChanges() logic

**Acceptance Criteria**:

- [ ] Prompt logic extracted to `src/prompts/commit-message-prompt.ts` as pure functions
- [ ] `buildCommitMessagePrompt()` is testable in isolation (no dependencies on generator)
- [ ] Generator calls prompt builder instead of constructing prompts inline
- [ ] Tests cover prompt structure, diff truncation, and context inclusion
- [ ] All existing generator tests still pass (prompts are functionally equivalent)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md for layer boundaries (prompts belong in Utils layer) and patterns.md for pure function pattern.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
bun run lint:fix
bun test src/prompts/__tests__/commit-message-prompt.test.ts
bun test src/generator.test.ts
```

---

### Task 2: Standardize Codex Agent Execution

**Files**:

- src/agents/codex.ts (modify)
- src/agents/__tests__/codex.test.ts (modify)

**Complexity**: M (3h)

**Dependencies**: None

**Description**:
Refactor Codex agent to use direct CLI execution with stdin/args (matching Claude/Gemini pattern) instead of temp file I/O. This eliminates ~80 LOC of file handling complexity and makes all agents use consistent execution patterns.

**Implementation Steps**:

1. Update `src/agents/codex.ts`:
   - Modify `executeCommand()` to use `exec('codex', ['exec', '--skip-git-repo-check'], { input: prompt })` pattern
   - Remove temp file logic: `_readOutput()`, `_cleanupTempFile()` methods
   - Remove `tmpFile` variable and file operations
   - Keep `cleanResponse()` override (Codex-specific artifact cleaning still needed)
   - Verify implementation matches Claude/Gemini pattern (~40-70 LOC)
2. Update `src/agents/__tests__/codex.test.ts`:
   - Remove temp file mocking logic
   - Update mocks to use stdin pattern (mock `exec` with `input` parameter)
   - Test execution with prompt as stdin
   - Test that cleanResponse() still removes Codex artifacts
   - Verify tests match structure of claude.test.ts and gemini.test.ts

**Acceptance Criteria**:

- [ ] Codex agent uses `exec('codex', ['exec'], { input: prompt })` pattern (no temp files)
- [ ] `_readOutput()` and `_cleanupTempFile()` methods removed (~30 LOC reduction)
- [ ] Codex agent ~40-70 LOC (matching Claude/Gemini)
- [ ] Tests updated to reflect new execution pattern (no temp file mocking)
- [ ] All three agents (Claude, Codex, Gemini) have identical test structure

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md for BaseAgent pattern (â‰¤3 extension points) and agent standardization rules.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
bun run lint:fix
bun test src/agents/__tests__/codex.test.ts
bun test src/agents/__tests__/claude.test.ts
bun test src/agents/__tests__/gemini.test.ts
```

---

## Phase 2: CLI and Generator Simplification (Sequential)

**Strategy**: sequential
**Reason**: Tasks must run in order - CLI changes depend on generator changes, docs depend on all code changes

### Task 3: Remove Manual Mode and Add Quiet Flag

**Files**:

- src/cli/schemas.ts (modify)
- src/cli/helpers.ts (modify)
- src/cli.ts (modify)
- src/cli/__tests__/schemas.test.ts (modify)
- src/cli/__tests__/helpers.test.ts (modify)
- src/generator.ts (modify)
- src/types/schemas.ts (modify)

**Complexity**: L (6h)

**Dependencies**: task-1 (prompts module must exist for generator to import)

**Description**:
Remove dual-mode complexity by eliminating manual fallback mode. Remove `--no-ai` flag and `enableAI` config, delete all rule-based generation methods from generator (~150 LOC deletion). Add `--quiet` flag for suppressing progress messages. This creates a simpler, AI-only code path.

**Implementation Steps**:

1. Update `src/cli/schemas.ts`:
   - Remove `ai: z.boolean().default(true)` field from schema
   - Add `quiet: z.boolean().default(false)` field
   - Update validation tests to verify new schema
2. Update `src/cli/helpers.ts`:
   - Modify `displayGeneratingMessage(agent, quiet)` to accept `quiet` parameter
   - Show messages to stderr unless `quiet` is true
   - Keep existing chalk formatting
3. Update `src/cli.ts`:
   - Remove `--no-ai` flag definition
   - Add `--quiet` flag with description: "Suppress progress messages (useful for scripting)"
   - Pass `quiet` option to `displayGeneratingMessage()`
   - Update help text to remove references to manual mode
4. Update `src/generator.ts`:
   - Remove `enableAI` field from `CommitMessageGeneratorConfig` type
   - Remove `enableAI` field from `this.config`
   - Remove lines 160-176 (AI vs fallback decision logic)
   - Remove `_generateRuleBasedCommitMessage()` method (~40 LOC)
   - Remove `_categorizeFiles()` method (~30 LOC)
   - Remove `_createBulletPoints()` method (~25 LOC)
   - Remove `_determineCommitType()` method (~20 LOC)
   - Remove `_formatCommitMessage()` method (~35 LOC)
   - Simplify `generateCommitMessage()` to always call `_generateAICommitMessage()`
   - Update error messages to guide users to install agent CLIs
5. Update `src/types/schemas.ts`:
   - Remove `enableAI: z.boolean().default(true)` from `generatorConfigSchema`
   - Update type inference
6. Update tests:
   - `src/cli/__tests__/schemas.test.ts`: Remove `--no-ai` tests, add `--quiet` tests
   - `src/cli/__tests__/helpers.test.ts`: Test `displayGeneratingMessage()` with quiet parameter
   - `src/generator.test.ts`: Remove manual mode tests, remove tests for deleted methods
   - Verify all remaining tests pass

**Acceptance Criteria**:

- [ ] `--no-ai` flag removed from CLI and schemas
- [ ] `--quiet` flag added and working (suppresses stderr output)
- [ ] `enableAI` config option removed from generator
- [ ] Manual fallback methods removed from generator (~150 LOC reduction)
- [ ] Generator always uses AI; agent failures throw errors (no silent fallback)
- [ ] Default behavior shows "ðŸ¤– Generating..." message in all modes (git hooks and CLI)
- [ ] Error messages provide clear installation instructions when agent fails
- [ ] Net reduction of ~200 LOC from codebase (prompt extraction saves ~60 LOC, Codex saves ~80 LOC, manual mode removal saves ~150 LOC = ~290 LOC total, some overhead from prompts module = ~200 net)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See architecture.md for layer boundaries and patterns.md for validation patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
bun run lint:fix
bun test src/cli/__tests__/schemas.test.ts
bun test src/cli/__tests__/helpers.test.ts
bun test src/generator.test.ts
bun test  # Run all tests to verify no regressions
```

---

### Task 4: Update Documentation and Migration Guide

**Files**:

- CHANGELOG.md (modify)
- README.md (modify)
- CLAUDE.md (modify)

**Complexity**: M (4h)

**Dependencies**: task-1, task-2, task-3 (all code changes must be complete)

**Description**:
Document breaking changes with clear migration instructions. Update CHANGELOG to explain `--no-ai` removal and `--quiet` addition. Update README to remove manual mode references and add quiet flag docs. Update CLAUDE.md to reflect new architecture.

**Implementation Steps**:

1. Update `CHANGELOG.md`:
   - Add new version section (use semantic versioning - likely 1.0.0 or 2.0.0 for breaking change)
   - Document breaking change: `--no-ai` flag removed
   - Add migration guide section:
     - "If you use `--no-ai`, install AI CLI (Claude/Codex/Gemini) and remove flag"
     - Provide installation links for each agent
     - Explain error messages will guide installation
   - Document new feature: `--quiet` flag
   - Document internal changes: prompt module, Codex agent standardization
2. Update `README.md`:
   - Remove all references to `--no-ai` flag
   - Remove manual/rule-based fallback descriptions
   - Add `--quiet` flag to CLI flags section with description and example
   - Update architecture diagram/description if it mentions dual-mode
   - Add note: "commitment is AI-only; ensure you have Claude, Codex, or Gemini CLI installed"
3. Update `CLAUDE.md`:
   - Update "Architecture Overview" section to remove manual fallback mention
   - Update "Key Design Patterns" to change "AI-First with Fallback" to "AI-Only"
   - Update generator description to remove `enableAI` config mention
   - Add prompts module to file structure
   - Update CLI flags list (remove `--no-ai`, add `--quiet`)
   - Verify all code examples are still accurate

**Acceptance Criteria**:

- [ ] CHANGELOG documents breaking change with migration instructions
- [ ] CHANGELOG includes installation links for Claude, Codex, Gemini CLIs
- [ ] README removes all `--no-ai` references
- [ ] README documents `--quiet` flag with examples
- [ ] CLAUDE.md reflects new architecture (AI-only, prompts module)
- [ ] All documentation is accurate and up-to-date

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

See docs/constitutions/current/meta.md for documentation standards.

**Quality Gates**:

```bash
# Verify links in docs are valid
grep -r "https://" CHANGELOG.md README.md CLAUDE.md

# Verify no references to removed features
! grep -r "\-\-no-ai" README.md CLAUDE.md
! grep -r "enableAI" README.md CLAUDE.md

# Manual review
cat CHANGELOG.md
cat README.md | grep -A5 "quiet"
```

---

## Summary

This plan refactors the commitment architecture to:

1. **Standardize agents** - All agents use identical execution patterns (Codex no longer uses temp files)
2. **Extract prompts** - Prompt logic moved to dedicated testable module
3. **Simplify codebase** - Remove ~200 LOC by eliminating manual fallback mode
4. **Improve UX** - Add `--quiet` flag, show progress by default in git hooks

The parallel phase (Tasks 1 & 2) can run simultaneously since prompt extraction and Codex refactor share no files. The sequential phase (Tasks 3 & 4) must run in order since CLI changes depend on generator changes, and docs depend on all code being complete.

**Time savings**: Executing Task 1 and Task 2 in parallel saves 3 hours compared to sequential execution (7h parallel vs 10h sequential).
