---
runId: 38166d
feature: shell-adapter
created: 2025-10-22
status: ready
---

# Feature: Shell Execution Adapter - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/38166d-shell-adapter/spec.md
> **Created:** 2025-10-22

## Execution Summary

- **Total Tasks**: 4
- **Total Phases**: 4
- **Sequential Time**: 20h
- **Parallel Time**: 20h
- **Time Savings**: 0h (0%)

**Parallel Opportunities:**
None - all tasks have dependencies due to shared files and layer boundaries.

---

## Phase 1: Shell Adapter Foundation

**Strategy**: sequential
**Reason**: Foundation task - no dependencies, must complete before migration

### Task 1: Create Shell Execution Adapter

**Files**:
- `src/utils/shell.ts`
- `src/utils/__tests__/shell.test.ts`
- `src/utils/index.ts`

**Complexity**: M (4h)

**Dependencies**: None

**Description**:
Create a runtime-adaptive shell execution utility that uses Bun.spawn in Bun runtime and execa in Node runtime. This is a pure function that provides a consistent interface for shell command execution across both runtimes, eliminating the need for complex execa mocking in Bun tests.

**Implementation Steps**:

1. Create `src/utils/shell.ts`:
   - Define `ShellExecOptions` type (cwd, timeout, input)
   - Define `ShellExecResult` type (stdout, stderr, exitCode)
   - Implement runtime detection: `const isBun = typeof process.versions.bun !== 'undefined'`
   - Implement Bun path using `Bun.spawn()`:
     - Convert options to Bun.spawn format
     - Handle stdin input via Bun.Subprocess
     - Capture stdout/stderr via `await result.text()`
     - Map exitCode from process result
   - Implement Node path using `execa`:
     - Pass through options directly
     - Map execa result to ShellExecResult format
   - Implement error handling:
     - Timeout errors with clear message
     - Exit code != 0 errors with stderr
     - CLI not found (ENOENT) errors with helpful message
     - Preserve original error as cause

2. Create comprehensive tests in `src/utils/__tests__/shell.test.ts`:
   - Test runtime detection (mock `process.versions.bun`)
   - Test Bun path with mocked `Bun.spawn`:
     - Success case (exit code 0)
     - Non-zero exit code
     - Timeout error
     - ENOENT error (command not found)
     - Stdin input handling
   - Test Node path with mocked `execa`:
     - Success case
     - Non-zero exit code
     - Timeout error
     - ENOENT error
   - Test options mapping (cwd, timeout, input)
   - Achieve >90% code coverage

3. Export from `src/utils/index.ts`:
   - Add `export { exec, type ShellExecOptions, type ShellExecResult } from './shell.js';`

**Acceptance Criteria**:
- [ ] `exec()` function implemented with runtime detection
- [ ] Bun path uses `Bun.spawn()` correctly
- [ ] Node path uses `execa` correctly
- [ ] All error cases handled with actionable messages
- [ ] Tests achieve >90% coverage
- [ ] Tests pass: `bun test src/utils/__tests__/shell.test.ts`
- [ ] Type checking passes: `bun run type-check`

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/v3/

- Pure function pattern (no side effects beyond process execution) - see v3/patterns.md
- Co-located tests - see v3/testing.md
- Type-safe with explicit types - see v3/schema-rules.md
- Utils module organization - see v3/architecture.md §Utils Module

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:
```bash
bun run lint
bun test src/utils/__tests__/shell.test.ts
bun run type-check
```

---

## Phase 2: Agent Layer Migration

**Strategy**: sequential
**Reason**: Depends on Phase 1 (shell adapter must exist). All agent files share base-agent.ts dependency.

### Task 2: Migrate Agent Layer to Shell Adapter

**Files**:
- `src/agents/base-agent.ts`
- `src/agents/__tests__/base-agent.test.ts`
- `src/agents/__tests__/claude.test.ts`
- `src/agents/__tests__/codex.test.ts`

**Complexity**: M (5h)

**Dependencies**: ["task-1-create-shell-adapter"]

**Description**:
Replace all `execa` usage in the agent layer with the new `exec()` utility. This simplifies test setup by allowing tests to mock Bun.spawn directly instead of using complex execa mocking with globalThis reassignment. Update BaseAgent and all agent tests to use the new adapter.

**Implementation Steps**:

1. Update `src/agents/base-agent.ts`:
   - Replace `import { execa } from 'execa'` with `import { exec } from '../utils/shell.js'`
   - Update `checkAvailability()` method:
     - Replace `execa('which', [cliCommand])` with `exec('which', [cliCommand], { cwd: workdir })`
     - Adapt error handling (exec already throws with clear messages)
   - Update `executeCommand()` calls (in concrete agent implementations if needed):
     - Verify agents use exec() instead of execa
     - Ensure options mapping is correct (cwd, timeout)

2. Simplify `src/agents/__tests__/base-agent.test.ts`:
   - Remove complex execa mocking setup (globalThis reassignment)
   - Replace with simple Bun.spawn mocking:
     ```typescript
     import { mock } from 'bun:test';

     mock.module('bun', () => ({
       spawn: mock((cmd, opts) => ({
         exitCode: Promise.resolve(0),
         stdout: { text: () => Promise.resolve('output') },
         stderr: { text: () => Promise.resolve('') }
       }))
     }));
     ```
   - Verify all test cases still pass
   - Remove ~20 lines of brittle mock setup code

3. Simplify `src/agents/__tests__/claude.test.ts`:
   - Remove execa mocking setup (lines 7-35)
   - Replace with Bun.spawn mocking
   - Verify all test cases pass
   - Test should be ~30 lines shorter

4. Simplify `src/agents/__tests__/codex.test.ts`:
   - Remove execa mocking setup
   - Replace with Bun.spawn mocking
   - Verify all test cases pass

5. Run full agent test suite to verify no regressions

**Acceptance Criteria**:
- [ ] BaseAgent uses `exec()` instead of `execa`
- [ ] All agent tests simplified (no execa mocking)
- [ ] Agent tests use Bun.spawn mocking directly
- [ ] All agent tests pass: `bun test src/agents/__tests__/`
- [ ] Test setup reduced by ~20-30 lines per test file
- [ ] Type checking passes: `bun run type-check`
- [ ] No behavior changes (same error handling, same outputs)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/v3/

- Agent layer boundaries - see v3/architecture.md §Agent Module
- BaseAgent template pattern (≤3 extension points) - see v3/architecture.md §Agent Module
- Co-located tests - see v3/testing.md

**TDD**: Follow `test-driven-development` skill (update tests first, watch fail, update code, watch pass)

**Quality Gates**:
```bash
bun run lint
bun test src/agents/__tests__/
bun run type-check
```

---

## Phase 3: CLI Layer Migration

**Strategy**: sequential
**Reason**: Depends on Phase 1 (shell adapter must exist). Can run in parallel with Phase 2 technically, but sequential is safer to avoid merge conflicts.

### Task 3: Migrate CLI Layer to Shell Adapter

**Files**:
- `src/cli/helpers.ts`
- `src/cli/__tests__/helpers.test.ts`

**Complexity**: M (3h)

**Dependencies**: ["task-1-create-shell-adapter"]

**Description**:
Replace `execa` usage in CLI helpers with the new `exec()` utility. This primarily affects git command execution. Update tests to use simplified Bun.spawn mocking instead of complex execa mocking.

**Implementation Steps**:

1. Update `src/cli/helpers.ts`:
   - Replace `import { execa } from 'execa'` with `import { exec } from '../utils/shell.js'`
   - Find all `execa()` calls (likely in git-related helpers)
   - Replace with `exec()` calls:
     - Example: `execa('git', ['status', '--porcelain'], { cwd })`
     - Becomes: `exec('git', ['status', '--porcelain'], { cwd })`
   - Verify error handling still works correctly
   - Update any catch blocks if needed (exec throws consistently)

2. Simplify `src/cli/__tests__/helpers.test.ts`:
   - Remove execa mocking setup
   - Replace with Bun.spawn mocking
   - Verify all test cases pass
   - Test should be significantly shorter

3. Run full CLI test suite to verify no regressions

**Acceptance Criteria**:
- [ ] CLI helpers use `exec()` instead of `execa`
- [ ] CLI helper tests simplified (no execa mocking)
- [ ] CLI tests use Bun.spawn mocking directly
- [ ] All CLI tests pass: `bun test src/cli/__tests__/`
- [ ] Type checking passes: `bun run type-check`
- [ ] No behavior changes (same git command execution, same error handling)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/v3/

- CLI layer boundaries - see v3/architecture.md §CLI Module
- CLI helpers organization - see v3/architecture.md §CLI Module
- Co-located tests - see v3/testing.md

**TDD**: Follow `test-driven-development` skill (update tests first, watch fail, update code, watch pass)

**Quality Gates**:
```bash
bun run lint
bun test src/cli/__tests__/
bun run type-check
```

---

## Phase 4: Full Validation

**Strategy**: sequential
**Reason**: Depends on all previous phases. This is the final verification step.

### Task 4: Full System Validation

**Files**:
- All modified files from previous tasks
- `package.json` (verify execa still listed for Node runtime)
- Build output (`dist/`)

**Complexity**: S (2h)

**Dependencies**: ["task-2-migrate-agent-layer", "task-3-migrate-cli-layer"]

**Description**:
Run comprehensive validation to ensure the shell adapter works correctly in both Bun and Node runtimes, all tests pass, and the CLI functions end-to-end. This is a verification-only task with no new code.

**Implementation Steps**:

1. Run full test suite in Bun runtime:
   - `bun test` - all tests should pass
   - Verify coverage is maintained (>90%)
   - Check that no execa mocking remains in tests

2. Verify Node runtime compatibility (if Node installed):
   - `node --version` (check if available)
   - If available: `node --experimental-modules dist/cli.js --dry-run`
   - Verify exec() uses execa path in Node

3. Run all quality gates:
   - `bun run type-check` - no type errors
   - `bun run lint` - no lint errors
   - `bun run build` - build succeeds
   - Verify dist/ contains CLI bundle

4. Run end-to-end CLI test:
   - `./dist/cli.js --dry-run` - should execute without errors
   - Verify shell adapter is used (check logs if needed)

5. Verify documentation:
   - README.md still accurate
   - CLAUDE.md still accurate
   - No references to "execa mocking pain" remain

6. Final verification checklist:
   - [ ] All tests pass: `bun test`
   - [ ] Type checking passes: `bun run type-check`
   - [ ] Linting passes: `bun run lint`
   - [ ] Build succeeds: `bun run build`
   - [ ] CLI works: `./dist/cli.js --dry-run`
   - [ ] No execa mocking in test files
   - [ ] Runtime detection works (Bun.spawn in Bun, execa in Node)

**Acceptance Criteria**:
- [ ] All tests pass: `bun test` (100% pass rate)
- [ ] Type checking passes: `bun run type-check` (0 errors)
- [ ] Linting passes: `bun run lint` (0 errors)
- [ ] Build succeeds: `bun run build` (clean output)
- [ ] CLI works end-to-end: `./dist/cli.js --dry-run` (executes without error)
- [ ] Node runtime works (if available): `node dist/cli.js --dry-run`
- [ ] Test coverage maintained (>90%)
- [ ] No execa mocking remains in any test file

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/v3/

See v3/testing.md for verification requirements.

**Quality Gates**:
```bash
bun test
bun run type-check
bun run lint
bun run build
./dist/cli.js --dry-run
```

---

## Implementation Notes

### TDD Workflow

For each task, follow the TDD cycle:

1. **RED**: Write/update tests first, watch them fail
2. **GREEN**: Write minimal code to make tests pass
3. **REFACTOR**: Clean up code while keeping tests green

### Constitution Compliance

All tasks must follow @docs/constitutions/v3/:

- **architecture.md**: Layer boundaries (utils → agents → CLI)
- **patterns.md**: Pure functions, no stateful utilities
- **schema-rules.md**: Type safety with explicit types
- **testing.md**: Co-located tests, >90% coverage
- **tech-stack.md**: Bun runtime, TypeScript strict mode

### Git Workflow

Use git-spice for stacked branches:

```bash
# Create branch for this feature
gs branch create 38166d-shell-adapter

# For each task:
git add {modified-files}
./dist/cli.js  # Generate commit message

# Create stacked branches if needed:
gs bc 38166d-task-2-agent-migration
gs bc 38166d-task-3-cli-migration
gs bc 38166d-task-4-validation

# Submit entire stack:
gs stack submit
```

### Verification Commands

After each task:

```bash
# Quick validation
bun run lint
bun test {test-files}

# Full validation (Task 4 only)
bun test
bun run type-check
bun run build
./dist/cli.js --dry-run
```

### Success Metrics

- ✅ All tests pass (100% pass rate)
- ✅ Test setup simplified (~20-30 lines removed per test file)
- ✅ No execa mocking in any test file
- ✅ Runtime detection works in both Bun and Node
- ✅ Build succeeds with no errors
- ✅ CLI executes end-to-end without errors
- ✅ Type safety maintained (0 type errors)
- ✅ Code coverage >90%
