---
runId: 9e9a7f
feature: gemini-cli-integration
created: 2025-10-24
status: ready
---

# Feature: Gemini CLI Integration - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/9e9a7f-gemini-cli-integration/spec.md
> **Created:** 2025-10-24

## Execution Summary

- **Total Tasks**: 3
- **Total Phases**: 2
- **Sequential Time**: 14h
- **Parallel Time**: 11h
- **Time Savings**: 3h (21%)

**Parallel Opportunities:**

- Phase 1: 2 tasks run in parallel (3h saved)

**Chunking Strategy:**
This plan uses PR-sized, thematically coherent task chunks:
- **Task 1 (M)**: Complete foundation refactoring - extract all cleaning utilities
- **Task 2 (L)**: Complete infrastructure layer - factory pattern + type system
- **Task 3 (L)**: Complete feature - new agent + CLI integration

Each task represents a reviewable PR that adds clear value.

---

## Phase 1: Foundation & Infrastructure

**Strategy**: Parallel
**Reason**: Tasks 1 and 2 have no shared files and can be developed simultaneously

**Phase Time**:
- Sequential: 3h + 5h = 8h
- Parallel: max(3h, 5h) = 5h
- **Savings: 3h (38% faster)**

### Task 1: Shared Cleaning Utilities Foundation

**Complexity**: M (3h)

**Dependencies**: None

**Files**:
- `src/agents/agent-utils.ts`
- `src/agents/__tests__/agent-utils.test.ts`
- `src/agents/claude.ts`
- `src/agents/codex.ts`

**Description**:
Extract duplicated commit message cleaning logic into shared utilities in agent-utils.ts, eliminating 6+ lines of duplicated code across Claude and Codex agents while preserving all functionality.

This task establishes the foundation for a cleaner, more maintainable agent system by centralizing common cleaning patterns (commit message markers, AI preambles) that should apply universally to all agents.

**Why This Task**:
- Reduces code duplication (DRY principle)
- Makes cleaning logic testable in isolation
- Prepares codebase for new agent (Gemini) to benefit from shared utilities
- Demonstrates immediate value (cleaner code) before adding complexity (factory pattern)

**Implementation Steps**:

1. **Add `cleanCommitMessageMarkers()` to agent-utils.ts**
   - Create pure function to remove `<<<COMMIT_MESSAGE_START>>>` and `<<<COMMIT_MESSAGE_END>>>` markers
   - Handle various formats (with/without angle brackets, spacing variations)
   - Add JSDoc documentation

2. **Add `cleanAIPreambles()` to agent-utils.ts**
   - Create pure function to remove common AI preambles ("here is the commit message:", "commit message:", etc.)
   - Use case-insensitive regex matching
   - Handle various preamble patterns from different AI models
   - Add JSDoc documentation

3. **Update `cleanAIResponse()` pipeline in agent-utils.ts**
   - Integrate new utilities into existing cleaning pipeline
   - Ensure cleaning happens in correct order (markers first, then preambles, then existing cleaners)
   - Maintain function purity (no side effects)

4. **Remove duplicated code from `claude.ts`**
   - Delete 2 lines removing commit message markers (now handled by agent-utils)
   - Simplify `cleanResponse()` override to only Claude-specific cleaning
   - Verify Claude agent still produces correct output

5. **Remove duplicated code from `codex.ts`**
   - Delete 4 lines removing markers and AI preambles (now handled by agent-utils)
   - Retain only Codex-specific cleaning (activity logs, metadata fields)
   - Simplify `cleanResponse()` override

6. **Add comprehensive tests to agent-utils.test.ts**
   - Test `cleanCommitMessageMarkers()` with various marker formats
   - Test `cleanAIPreambles()` with various AI-generated prefixes
   - Test updated `cleanAIResponse()` pipeline includes all cleaning stages
   - Test edge cases (no markers, multiple markers, nested patterns)

7. **Run quality gates**
   ```bash
   bun run lint
   bun test src/agents/__tests__/agent-utils.test.ts
   bun test src/agents/__tests__/claude.test.ts
   bun test src/agents/__tests__/codex.test.ts
   ```

**Acceptance Criteria**:

- [ ] `cleanCommitMessageMarkers()` removes all marker variations from test cases
- [ ] `cleanAIPreambles()` removes all common AI preamble patterns from test cases
- [ ] `cleanAIResponse()` pipeline applies new utilities correctly
- [ ] Claude agent tests pass with 2 lines of duplication removed
- [ ] Codex agent tests pass with 4 lines of duplication removed
- [ ] New utility tests achieve >80% coverage
- [ ] All existing agent tests still pass (no behavior regression)
- [ ] `bun run lint` passes with no violations
- [ ] Functions remain pure (no state, no side effects)

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **Pure Functions**: agent-utils.ts functions must be stateless, side-effect-free (architecture.md)
- **Co-located Tests**: Tests in `src/agents/__tests__/` (testing.md)
- **No Breaking Changes**: Existing agent behavior unchanged (architecture.md)

**Quality Gates**:

```bash
bun run lint
bun test src/agents/__tests__/
bun test --coverage
```

---

### Task 2: Agent Factory & Type System

**Complexity**: L (5h)

**Dependencies**: None (parallel with Task 1)

**Files**:
- `src/agents/factory.ts` (new)
- `src/agents/__tests__/factory.test.ts` (new)
- `src/agents/types.ts`
- `src/agents/index.ts`
- `src/generator.ts`
- `src/cli/schemas.ts`

**Description**:
Create agent factory using ts-pattern for type-safe, exhaustive agent instantiation, replacing the if/else chain in generator.ts. Update type system to include 'gemini' as a valid agent name. This task establishes the infrastructure for adding new agents easily.

**Why This Task**:
- Improves maintainability: Single location to add new agents
- Type safety: ts-pattern provides exhaustiveness checking
- Architectural improvement: Factory pattern approved per patterns.md
- Prepares for Task 3 (Gemini agent) by extending type system

**Implementation Steps**:

1. **Update `AgentName` type in types.ts**
   - Change from `'claude' | 'codex'` to `'claude' | 'codex' | 'gemini'`
   - Update JSDoc to mention all three agents
   - Verify type changes propagate correctly

2. **Create `src/agents/factory.ts`**
   - Import `match` from 'ts-pattern'
   - Import Agent types and concrete agent classes
   - Implement `createAgent(name: AgentName): Agent` function
   - Use `match(name).with('claude', ...).with('codex', ...).with('gemini', ...).exhaustive()`
   - Keep function ≤15 LOC as per NFR1
   - Add JSDoc with usage example

3. **Add tests in `__tests__/factory.test.ts`**
   - Test `createAgent('claude')` returns ClaudeAgent instance
   - Test `createAgent('codex')` returns CodexAgent instance
   - Test `createAgent('gemini')` returns GeminiAgent instance (will fail until Task 3)
   - Test type safety (TypeScript compilation errors for invalid names)
   - Test exhaustiveness checking catches missing cases

4. **Update `src/agents/index.ts`**
   - Add `export { createAgent } from './factory.js';`
   - Verify barrel exports are clean and organized

5. **Update `src/generator.ts` to use factory**
   - Import `createAgent` from './agents/factory'
   - Replace ternary operator: `this.agent = agentName === 'claude' ? new ClaudeAgent() : new CodexAgent()`
   - With: `this.agent = createAgent(agentName)`
   - Update default signature logic to include Gemini case using ts-pattern
   - Verify CommitMessageGeneratorConfig type accepts 'gemini'

6. **Update `src/cli/schemas.ts`**
   - Ensure CLI schema validation accepts 'gemini' as valid agent name
   - Update agent enum or union type if schema exists
   - Add test for 'gemini' validation

7. **Run quality gates**
   ```bash
   bun run lint
   bun run type-check
   bun test src/agents/__tests__/factory.test.ts
   bun test src/__tests__/generator.test.ts
   ```

**Acceptance Criteria**:

- [ ] `AgentName` type includes 'claude' | 'codex' | 'gemini'
- [ ] `createAgent()` function ≤15 LOC using ts-pattern
- [ ] Factory returns correct agent instance for 'claude' and 'codex'
- [ ] Factory provides exhaustiveness checking (TypeScript error if case missing)
- [ ] Generator.ts replaces if/else with single `createAgent()` call
- [ ] CLI schemas accept 'gemini' as valid agent option
- [ ] Factory tests achieve >80% coverage
- [ ] `bun run type-check` passes with no errors
- [ ] `bun run lint` passes with no violations
- [ ] Existing generator tests still pass

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **ts-pattern for Factory**: Use ts-pattern match().exhaustive() (patterns.md)
- **Type Safety**: Exhaustive checking prevents missing cases (tech-stack.md)
- **Layer Boundaries**: Factory in Agent layer, called by Generator layer (architecture.md)
- **Co-located Tests**: Tests in `src/agents/__tests__/` (testing.md)

**Quality Gates**:

```bash
bun run lint
bun run type-check
bun test src/agents/__tests__/factory.test.ts
bun test
```

---

## Phase 2: Feature Implementation

**Strategy**: Sequential
**Reason**: Task 3 shares `src/agents/index.ts` with Task 2, creating file dependency

**Phase Time**: 6h

### Task 3: Gemini Agent Implementation & CLI Integration

**Complexity**: L (6h)

**Dependencies**: task-2-agent-factory-type-system (shares `src/agents/index.ts`)

**Dependency Reason**: Both tasks modify `src/agents/index.ts` for exports. Task 3 adds `export { GeminiAgent }` while Task 2 adds `export { createAgent }`. Must run after Task 2 completes.

**Files**:
- `src/agents/gemini.ts` (new)
- `src/agents/__tests__/gemini.test.ts` (new)
- `src/agents/index.ts`
- `src/cli.ts`

**Description**:
Implement GeminiAgent extending BaseAgent, using `gemini -p "<prompt>"` CLI for commit message generation. Integrate with CLI by updating help text and exports. This task delivers the main feature: Gemini as a third agent option.

**Why This Task**:
- Delivers user-facing feature: `commitment --agent gemini`
- Demonstrates BaseAgent extensibility (v3 architecture)
- Completes the agent triad (Claude, Codex, Gemini)
- Validates factory pattern from Task 2 works correctly

**Implementation Steps**:

1. **Create `src/agents/gemini.ts`**
   - Import BaseAgent and required dependencies
   - Define GeminiAgent class extending BaseAgent
   - Set `readonly name = 'gemini'`
   - Implement `executeCommand()` method:
     - Use `execa('gemini', ['-p', prompt], { cwd: workdir, timeout: 120_000 })`
     - Handle CLI not found error (throw AgentError.cliNotFound)
     - Handle execution errors (throw AgentError.executionFailed)
     - Return stdout from gemini command
   - No `cleanResponse()` override needed (Gemini produces clean output per spec)
   - Keep implementation ~40-60 LOC
   - Add comprehensive JSDoc

2. **Add tests in `__tests__/gemini.test.ts`**
   - Test agent has correct name ('gemini')
   - Test `executeCommand()` with mocked gemini CLI
   - Test CLI not found error handling (mock execa to throw ENOENT)
   - Test execution timeout (verify 120s timeout)
   - Test malformed response handling
   - Test standard flow via BaseAgent inheritance
   - Mock execa to avoid real CLI dependencies

3. **Update `src/agents/index.ts`**
   - Add `export { GeminiAgent } from './gemini.js';`
   - Verify all agents (Claude, Codex, Gemini) and factory are exported
   - Maintain alphabetical order

4. **Update `src/cli.ts`**
   - Change `--agent` option description to: `'AI agent to use: claude, codex, gemini (default: "claude")'`
   - Verify default remains 'claude'
   - No other CLI changes needed

5. **Update factory tests from Task 2**
   - Uncomment or enable `createAgent('gemini')` test
   - Verify factory returns GeminiAgent instance
   - Verify exhaustiveness checking includes Gemini case

6. **Run integration tests**
   - Test `./dist/cli.js --agent gemini --dry-run` (if Gemini CLI installed)
   - Test `./dist/cli.js --agent gemini` without CLI (verify error message)
   - Test default agent still works (`./dist/cli.js`)

7. **Run quality gates**
   ```bash
   bun run build
   bun run lint
   bun run type-check
   bun test src/agents/__tests__/gemini.test.ts
   bun test src/agents/__tests__/factory.test.ts
   bun test --coverage
   ```

**Acceptance Criteria**:

- [ ] GeminiAgent extends BaseAgent correctly
- [ ] `executeCommand()` uses `gemini -p` with 120s timeout
- [ ] CLI not found error includes helpful installation message
- [ ] Execution errors are handled with AgentError.executionFailed
- [ ] GeminiAgent implementation is ~40-60 LOC (consistent with Claude/Codex)
- [ ] Unit tests achieve >80% coverage
- [ ] Factory returns GeminiAgent instance for 'gemini' name
- [ ] CLI help text includes 'gemini' in agent list
- [ ] Default agent remains 'claude'
- [ ] `bun test` passes all tests (100% pass rate)
- [ ] `bun run type-check` passes with no errors
- [ ] `bun run lint` passes with no violations
- [ ] Overall test coverage ≥80% maintained

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/

- **BaseAgent Extension**: Implement only `executeCommand()` extension point (architecture.md)
- **Template Method Pattern**: Inherit checkAvailability(), cleanResponse(), validateResponse() (architecture.md)
- **Actionable Errors**: Use AgentError static factories (cliNotFound, executionFailed) (patterns.md)
- **Co-located Tests**: Tests in `src/agents/__tests__/` (testing.md)
- **120s Timeout**: Consistent with other agents (tech-stack.md)

**Quality Gates**:

```bash
bun run build
bun run lint
bun run type-check
bun test
bun test --coverage
```

**Manual Verification**:

```bash
# With Gemini CLI installed:
./dist/cli.js --agent gemini --dry-run

# Without Gemini CLI (verify error):
# (Temporarily rename gemini binary if installed)
./dist/cli.js --agent gemini --dry-run

# Default agent still works:
./dist/cli.js --dry-run
```

---

## Overall Acceptance Criteria

**Constitution Compliance:**
- [ ] BaseAgent extension follows v3 pattern (@docs/constitutions/current/architecture.md)
- [ ] ts-pattern used for factory (@docs/constitutions/current/patterns.md)
- [ ] Pure utility functions for shared logic (@docs/constitutions/current/architecture.md)
- [ ] Co-located tests in `__tests__/` directories (@docs/constitutions/current/testing.md)
- [ ] No factories/provider chains beyond simple factory function (@docs/constitutions/current/architecture.md)

**Feature-Specific:**
- [ ] `commitment --agent gemini` generates commit messages using Gemini CLI
- [ ] GeminiAgent properly handles CLI not found error with helpful message
- [ ] GeminiAgent respects 120-second timeout consistent with other agents
- [ ] Commit message markers removed by shared utility (Claude/Codex no longer duplicate)
- [ ] AI preambles removed by shared utility (universal across all agents)
- [ ] Factory function returns correct agent instance for each AgentName
- [ ] Factory function provides exhaustiveness checking via ts-pattern
- [ ] Default agent remains 'claude' when not specified

**Code Quality:**
- [ ] Duplication eliminated: 6+ lines of cleaning code removed
- [ ] GeminiAgent implementation ~40-60 LOC (consistent with Claude/Codex)
- [ ] Factory function ≤15 LOC using ts-pattern
- [ ] All cleaning utilities are pure functions (no state, no side effects)

**Testing:**
- [ ] GeminiAgent unit tests cover executeCommand(), errors, CLI availability
- [ ] Factory tests verify correct instantiation and exhaustiveness
- [ ] Cleaning utility tests verify marker and preamble removal
- [ ] Claude and Codex tests still pass after removing duplicated code
- [ ] Integration tests verify end-to-end Gemini agent flow
- [ ] Overall test coverage ≥80% maintained (@docs/constitutions/current/testing.md)

**Verification:**
- [ ] `bun test` passes all tests
- [ ] `bun run lint` passes with no violations
- [ ] `bun run type-check` passes with no errors
- [ ] `bun test --coverage` shows coverage ≥80%
- [ ] Manual test: `./dist/cli.js --agent gemini --dry-run` generates valid commit message
- [ ] Manual test: Gemini CLI not installed produces helpful error message

---

## Time Estimates

**Sequential Execution**: 14h
- Task 1: 3h
- Task 2: 5h
- Task 3: 6h

**With Parallelization**: 11h
- Phase 1 (parallel): max(3h, 5h) = 5h
- Phase 2 (sequential): 6h

**Time Savings**: 3h (21% faster)

---

## Execution Strategy

**Recommended Approach**: Use git-spice for stacked branch workflow

**Branch Structure**:
```
main
├── task-1-cleaning-utilities (can be developed in parallel)
└── task-2-factory-pattern
    └── task-3-gemini-agent (stacked on task-2)
```

**Execution Flow**:

1. **Phase 1 (Parallel Development)**:
   - Developer A: Start `task-1-cleaning-utilities` branch from main
   - Developer B: Start `task-2-factory-pattern` branch from main
   - Both can work simultaneously (no file conflicts)

2. **Phase 2 (Sequential Development)**:
   - After Task 2 completes: Start `task-3-gemini-agent` stacked on `task-2-factory-pattern`
   - Or if using single developer: Continue from task-2 branch

3. **Review & Merge**:
   - Task 1 PR: Review cleaning utilities refactoring
   - Task 2 PR: Review factory pattern implementation
   - Task 3 PR: Review Gemini agent + CLI integration
   - Merge in any order (Task 1 and 2 independent, Task 3 requires Task 2)

**For Single Developer**:
```bash
# Phase 1: Start with foundation (can do in either order)
gs bc task-1-cleaning-utilities
# ... implement Task 1 ...
git add . && commitment

# Start infrastructure in parallel or after
git checkout main
gs bc task-2-factory-pattern
# ... implement Task 2 ...
git add . && commitment

# Phase 2: Stack feature on infrastructure
gs bc task-3-gemini-agent
# ... implement Task 3 ...
git add . && commitment

# Submit all PRs
gs stack submit
```

---

## References

- **Feature Spec**: specs/9e9a7f-gemini-cli-integration/spec.md
- **Constitution**: @docs/constitutions/current/
  - architecture.md - Layer boundaries and dependencies
  - patterns.md - Required patterns (ts-pattern for factory)
  - tech-stack.md - Approved dependencies
  - testing.md - Testing requirements (80% coverage)
- **External Docs**:
  - Gemini CLI: https://github.com/google-gemini/gemini-cli
  - ts-pattern: https://github.com/gvergnaud/ts-pattern
