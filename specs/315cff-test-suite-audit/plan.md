---
runId: 315cff
feature: test-suite-audit
created: 2025-01-22
status: ready
---

# Test Suite Audit - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/315cff-test-suite-audit/spec.md
> **Created:** 2025-01-22

## Execution Summary

- **Total Tasks**: 3
- **Total Phases**: 2
- **Sequential Time**: 12h
- **Parallel Time**: 8h
- **Time Savings**: 4h (33% faster)

**Parallel Opportunities:**

- Phase 1: 2 tasks running in parallel (4h saved)

**Task Sizing:**
- M (3-5h): 2 tasks (67%)
- L (5-7h): 1 task (33%)
- S (1-2h): 0 tasks (0%) ✅

---

## Phase 1: Core Test Cleanup

**Strategy**: Parallel
**Reason**: Tasks work on independent test files with no shared dependencies

**Time Estimate:**
- Sequential: 9h (4h + 5h)
- Parallel: 5h (max of 4h, 5h)
- **Savings: 4h (44% faster)**

### Task 1: Clean Schema Test Suites

**Files:**
- `src/types/__tests__/schemas.test.ts`
- `src/cli/__tests__/schemas.test.ts`

**Complexity**: M (4h)

**Dependencies**: None

**Description:**
Remove Zod validation tests from schema test files, keeping only type inference tests and custom business logic tests (formatValidationError). This task combines both schema-related test suites for thematic coherence.

**Rationale:**
These tests verify that Zod works correctly (e.g., "rejects non-string input") rather than testing our custom validation logic. We trust Zod's validation and focus our tests on business logic built on top of schemas.

**Implementation Steps:**

1. **src/types/__tests__/schemas.test.ts** (829 LOC → ~50 LOC):
   - Delete lines 18-789 (Zod parsing tests for commitTaskSchema, commitMessageOptionsSchema, etc.)
   - Keep lines 772-829 (type inference tests)
   - Add top-of-file comment explaining testing philosophy
   - Verify: Only type inference tests remain (~50 LOC)

2. **src/cli/__tests__/schemas.test.ts** (360 LOC → ~50 LOC):
   - Delete lines 14-266 (Zod validation tests for cliOptionsSchema)
   - Keep lines 267-315 (formatValidationError tests - custom business logic)
   - Add top-of-file comment explaining testing philosophy
   - Verify: Only formatValidationError tests remain (~50 LOC)

3. **Run quality gates:**
   ```bash
   bun test src/types/__tests__/schemas.test.ts
   bun test src/cli/__tests__/schemas.test.ts
   bun run lint
   ```

**Acceptance Criteria:**
- [ ] `src/types/__tests__/schemas.test.ts` reduced to <100 LOC (type inference only)
- [ ] `src/cli/__tests__/schemas.test.ts` reduced to <50 LOC (formatValidationError only)
- [ ] All tests pass: `bun test src/types/__tests__/schemas.test.ts src/cli/__tests__/schemas.test.ts`
- [ ] No Zod validation tests remain (e.g., "rejects non-string", "applies default")
- [ ] Type inference tests verify z.infer<> produces correct types
- [ ] formatValidationError tests verify custom error formatting logic

**Decision Rules:**

**DELETE a test if:**
- It verifies Zod rejects invalid types: `expect(() => schema.parse(123)).toThrow()`
- It verifies Zod applies defaults: `expect(result.field).toBe(defaultValue)`
- It verifies Zod validates constraints: `expect(() => schema.parse('')).toThrow()`
- It doesn't test any logic **we wrote**

**KEEP a test if:**
- It verifies type inference: `const x: MyType = {...}; expect(x.field).toBe(...)`
- It verifies custom validation logic: `formatValidationError()` tests
- It verifies business logic behavior built on schemas

**Mandatory Patterns:**

> **Constitution**: All code must follow @docs/constitutions/current/

- **Schema-First Development** (@docs/constitutions/current/schema-rules.md): "Validate at boundaries, trust types internally"
- **Testing Requirements** (@docs/constitutions/current/testing.md): Test business logic, not library behavior

**Quality Gates:**
```bash
bun test src/types/__tests__/schemas.test.ts src/cli/__tests__/schemas.test.ts
bun run lint
```

---

### Task 2: Clean Utils Test Suite

**Files:**
- `src/utils/__tests__/git-schemas.test.ts`

**Complexity**: L (5h)

**Dependencies**: None

**Description:**
Remove Zod validation tests from git-schemas test file, preserving all business logic tests for parseGitStatus, categorizeFiles, analyzeChanges, and type inference. This is the largest and most complex test file cleanup.

**Rationale:**
This file contains ~900 LOC of Zod validation tests and ~400 LOC of critical business logic tests. The business logic tests verify our custom parsing and categorization logic - essential functionality we own. Zod validation tests just verify Zod works.

**Implementation Steps:**

1. **Identify sections to delete** (review file structure):
   - Lines 22-474: gitStatusLineSchema, gitStatusSchema, fileCategoriesSchema Zod tests
   - Lines 476-642: Validation helper Zod tests
   - Lines 1168-1226: More validation helper Zod tests

2. **Identify sections to keep**:
   - Lines 644-761: parseGitStatus tests (business logic - parses git output)
   - Lines 763-910: categorizeFiles tests (business logic - categorizes by file type)
   - Lines 912-1166: changeStatsSchema + analyzeChanges tests (business logic - extracts statistics)
   - Lines 1228-1293: Type inference tests

3. **Execute deletion** (1294 LOC → ~400 LOC):
   - Delete lines 22-642 (schema validation tests)
   - Delete lines 1168-1226 (validation helper tests)
   - Keep lines 644-1166 (business logic tests)
   - Keep lines 1228-1293 (type inference tests)
   - Add top-of-file comment explaining testing philosophy

4. **Verify business logic coverage:**
   ```bash
   bun test src/utils/__tests__/git-schemas.test.ts --coverage
   ```
   - parseGitStatus: Empty output, single file, multiple files, edge cases
   - categorizeFiles: Different file types (tests, components, configs, etc.)
   - analyzeChanges: Added, modified, deleted, renamed files
   - Type inference: Verify z.infer<> produces correct types

5. **Run quality gates:**
   ```bash
   bun test src/utils/__tests__/git-schemas.test.ts
   bun run lint
   ```

**Acceptance Criteria:**
- [ ] `src/utils/__tests__/git-schemas.test.ts` reduced to ~400 LOC (business logic + type inference)
- [ ] All business logic tests preserved: parseGitStatus, categorizeFiles, analyzeChanges
- [ ] All type inference tests preserved
- [ ] All tests pass: `bun test src/utils/__tests__/git-schemas.test.ts`
- [ ] No Zod validation tests remain (e.g., "rejects invalid status code")
- [ ] Business logic coverage maintained at 100%

**Decision Rules:**

**DELETE:**
- Schema validation tests (gitStatusLineSchema, gitStatusSchema, etc.)
- Tests verifying Zod constraints (min length, regex patterns, etc.)
- Validation helper tests that just call schema.parse()

**KEEP:**
- parseGitStatus() tests - parses git status output into structured data
- categorizeFiles() tests - categorizes files by type (tests, components, etc.)
- analyzeChanges() tests - extracts change statistics from git output
- Type inference tests - verify schema → type mapping

**Mandatory Patterns:**

> **Constitution**: All code must follow @docs/constitutions/current/

- **Schema-First Development** (@docs/constitutions/current/schema-rules.md): "Validate at boundaries, trust types internally"
- **Testing Requirements** (@docs/constitutions/current/testing.md): Focus on business logic, not library validation

**Quality Gates:**
```bash
bun test src/utils/__tests__/git-schemas.test.ts --coverage
bun run lint
```

---

## Phase 2: Final Cleanup & Documentation

**Strategy**: Sequential
**Reason**: Task 3 adds documentation to all files modified in Phase 1, so it must wait for completion

**Time Estimate:**
- Sequential: 3h
- Parallel: N/A (single task)

### Task 3: Clean Agents Test Suite & Add Documentation

**Files:**
- `src/agents/__tests__/types.test.ts`
- `src/types/__tests__/schemas.test.ts` (documentation)
- `src/cli/__tests__/schemas.test.ts` (documentation)
- `src/utils/__tests__/git-schemas.test.ts` (documentation)

**Complexity**: M (3h)

**Dependencies**: [task-1, task-2]
**Dependency Reason**: Adds documentation to files modified in Tasks 1 and 2

**Description:**
Complete the test suite cleanup by removing Zod validation tests from agents types test file, then add comprehensive documentation comments to all modified test files explaining the testing philosophy (test business logic, not Zod).

**Rationale:**
The agents types test file follows the same pattern as others - mostly Zod validation tests with a small amount of interface testing. After cleanup, we add documentation to guide future developers on what to test and what not to test.

**Implementation Steps:**

1. **Clean src/agents/__tests__/types.test.ts** (259 LOC → ~40 LOC):
   - Keep lines 12-39 (Agent interface tests)
   - Delete lines 41-257 (Zod validation tests for AgentConfig, etc.)
   - Add top-of-file comment explaining testing philosophy

2. **Add documentation to all test files:**
   - `src/types/__tests__/schemas.test.ts`
   - `src/cli/__tests__/schemas.test.ts`
   - `src/utils/__tests__/git-schemas.test.ts`
   - `src/agents/__tests__/types.test.ts`

3. **Documentation comment template:**
   ```typescript
   /**
    * Schema Tests - Testing Philosophy
    *
    * We DON'T test Zod's validation logic:
    * - ❌ "rejects non-string input"
    * - ❌ "rejects empty string"
    * - ❌ "applies default values"
    *
    * We DO test our custom logic built on schemas:
    * - ✅ Type inference (z.infer<> produces correct types)
    * - ✅ Data transformations (parseGitStatus, categorizeFiles)
    * - ✅ Custom validation (formatValidationError)
    * - ✅ Business logic (analyzeChanges)
    *
    * Rationale: Zod is well-tested. We focus on behavior we own.
    *
    * See: @docs/constitutions/current/schema-rules.md
    */
   ```

4. **Verify all tests still pass:**
   ```bash
   bun test
   ```

5. **Run quality gates:**
   ```bash
   bun run lint
   bun test --coverage
   ```

**Acceptance Criteria:**
- [ ] `src/agents/__tests__/types.test.ts` reduced to <50 LOC (interface tests only)
- [ ] All four test files have documentation comments explaining testing philosophy
- [ ] Documentation references @docs/constitutions/current/schema-rules.md
- [ ] All tests pass: `bun test`
- [ ] Coverage maintained for all business logic functions
- [ ] No Zod validation tests remain in any file

**Mandatory Patterns:**

> **Constitution**: All code must follow @docs/constitutions/current/

- **Schema-First Development** (@docs/constitutions/current/schema-rules.md): "Validate at boundaries, trust types internally"
- **Testing Requirements** (@docs/constitutions/current/testing.md): Document testing philosophy for future developers

**Quality Gates:**
```bash
bun test
bun test --coverage
bun run lint
```

---

## Success Metrics

**Before:**
- Total test LOC: ~4000
- Schema validation test LOC: ~2400 (60%)
- Business logic test LOC: ~1600 (40%)

**After:**
- Total test LOC: ~2500
- Schema validation test LOC: ~100 (4%)
- Business logic test LOC: ~2400 (96%)

**Result**: 37.5% reduction in total test LOC, 96% focused on business logic.

**File-Level Targets:**
- `src/types/__tests__/schemas.test.ts`: 829 LOC → ~50 LOC (93% reduction)
- `src/cli/__tests__/schemas.test.ts`: 360 LOC → ~50 LOC (86% reduction)
- `src/utils/__tests__/git-schemas.test.ts`: 1294 LOC → ~400 LOC (69% reduction)
- `src/agents/__tests__/types.test.ts`: 259 LOC → ~40 LOC (85% reduction)

---

## Verification Checklist

After completing all tasks, verify:

- [ ] Total test LOC reduced by ~1500 lines
- [ ] All tests pass: `bun test`
- [ ] Coverage maintained for business logic: `bun test --coverage`
- [ ] Linting passes: `bun run lint`
- [ ] No Zod validation tests remain (search for "should reject", "should apply default")
- [ ] Business logic tests preserved (parseGitStatus, categorizeFiles, analyzeChanges, formatValidationError, type guards)
- [ ] Documentation comments added to all modified files
- [ ] Type inference tests present for all schemas

---

## Constitution References

All tasks must follow:
- **Architecture** (@docs/constitutions/current/architecture.md): Co-located tests, module boundaries
- **Patterns** (@docs/constitutions/current/patterns.md): Schema-first development
- **Schema Rules** (@docs/constitutions/current/schema-rules.md): Validate at boundaries, trust types internally
- **Testing** (@docs/constitutions/current/testing.md): Test business logic, not libraries
