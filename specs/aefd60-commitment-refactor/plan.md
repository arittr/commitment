---
runId: aefd60
feature: commitment-refactor
created: 2025-10-21
status: ready
---

# Feature: Commitment Simplification & Quality Refactor - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/aefd60-commitment-refactor/spec.md
> **Created:** 2025-10-21

## Execution Summary

- **Total Tasks**: 7
- **Total Phases**: 6
- **Sequential Time**: 29h
- **Parallel Time**: 26h
- **Time Savings**: 3h (10.3%)

**Parallel Opportunities:**

- Phase 2: 2 tasks (3h saved)

---

## Phase 1: Foundation

**Strategy**: Sequential
**Reason**: Creates core types and structure needed by all other tasks

### Task 1: Agent System Foundation

**Files**:

- src/agents/types.ts
- src/agents/index.ts
- src/agents/__tests__/types.test.ts

**Complexity**: M (4h)

**Dependencies**: None

**Description**:

Create the new `src/agents/` directory structure with a simplified Agent interface. This replaces the complex Provider abstraction with a minimal interface focused on the single responsibility of generating commit messages. No base classes, no factory patterns - just a clean, simple interface that each agent will implement directly.

**Implementation Steps**:

1. Create `src/agents/` directory
2. Create `src/agents/types.ts` with simplified Agent interface:
   ```typescript
   interface Agent {
     name: string;
     generate(prompt: string, workdir: string): Promise<string>;
   }
   ```
3. Add Zod schema for agent configuration (just `agent: string` field)
4. Create `src/agents/index.ts` with exports
5. Add comprehensive TSDoc with examples per constitution patterns.md
6. Write unit tests for types and schemas (80%+ coverage)

**Acceptance Criteria**:

- [ ] `src/agents/types.ts` defines Agent interface with TSDoc
- [ ] Agent interface has exactly 2 methods: `name` property and `generate()` method
- [ ] No base classes or abstract classes exist in types.ts
- [ ] All types use kebab-case files, PascalCase types per constitution
- [ ] Tests achieve 80%+ coverage for type guards and schemas

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/types.test.ts
```

---

## Phase 2: Agent Implementations

**Strategy**: Parallel
**Reason**: Claude and Codex agents are independent implementations, both depend only on Phase 1 types

### Task 2: Implement Standalone Claude Agent

**Files**:

- src/agents/claude.ts
- src/agents/__tests__/claude.test.ts

**Complexity**: M (3h)

**Dependencies**: Task 1 (shares src/agents/types.ts)

**Description**:

Implement Claude agent as a standalone class (~50-100 LOC) without base classes. Directly implements the Agent interface with CLI execution logic inlined. Checks `claude` command availability, executes with prompt, parses conventional commit format. All logic self-contained - no shared utilities or base class inheritance.

**Implementation Steps**:

1. Create `src/agents/claude.ts` implementing Agent interface
2. Inline CLI availability check using `which claude`
3. Inline CLI execution using `execa('claude', [...])`
4. Inline response parsing (clean AI artifacts, extract commit message)
5. Add actionable error messages (what failed, why, how to fix)
6. Keep implementation under 100 LOC
7. Add comprehensive TSDoc with usage examples
8. Write unit tests covering success/failure cases (80%+ coverage)

**Acceptance Criteria**:

- [ ] Claude agent implements Agent interface directly (no base class)
- [ ] Total LOC for claude.ts is under 100 lines
- [ ] CLI not found error shows installation instructions
- [ ] Malformed response error includes diagnostic context
- [ ] All public methods have explicit return types and TSDoc
- [ ] Tests achieve 80%+ coverage

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/claude.test.ts
```

---

### Task 3: Implement Standalone Codex Agent

**Files**:

- src/agents/codex.ts
- src/agents/__tests__/codex.test.ts

**Complexity**: M (3h)

**Dependencies**: Task 1 (shares src/agents/types.ts)

**Description**:

Implement Codex agent as a standalone class (~50-100 LOC) without base classes. Directly implements the Agent interface with CLI execution logic inlined. Checks `codex` command availability, executes with prompt, parses conventional commit format. All logic self-contained - no shared utilities or base class inheritance.

**Implementation Steps**:

1. Create `src/agents/codex.ts` implementing Agent interface
2. Inline CLI availability check using `which codex`
3. Inline CLI execution using `execa('codex', [...])`
4. Inline response parsing (clean AI artifacts, extract commit message)
5. Add actionable error messages (what failed, why, how to fix)
6. Keep implementation under 100 LOC
7. Add comprehensive TSDoc with usage examples
8. Write unit tests covering success/failure cases (80%+ coverage)

**Acceptance Criteria**:

- [ ] Codex agent implements Agent interface directly (no base class)
- [ ] Total LOC for codex.ts is under 100 lines
- [ ] CLI not found error shows installation instructions
- [ ] Malformed response error includes diagnostic context
- [ ] All public methods have explicit return types and TSDoc
- [ ] Tests achieve 80%+ coverage

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/agents/__tests__/codex.test.ts
```

---

## Phase 3: Generator Simplification

**Strategy**: Sequential
**Reason**: Depends on agents being implemented in Phase 2

### Task 4: Simplify Generator & Remove Provider Chains

**Files**:

- src/generator.ts
- src/types/schemas.ts
- src/__tests__/generator.test.ts
- src/types/__tests__/schemas.test.ts

**Complexity**: L (6h)

**Dependencies**: Tasks 2, 3 (needs agents implemented)

**Description**:

Simplify `CommitMessageGenerator` by removing auto-detection and provider chain/fallback logic. Replace complex `ProviderConfig` with simple `agent: string` field. Remove dependency on provider-factory, provider-chain, and auto-detect modules. Configuration becomes just `{ agent: 'claude' | 'codex', enableAI: boolean }`. Validation simplified to basic Zod schema without discriminated unions or chain arrays.

**Implementation Steps**:

1. Update `src/types/schemas.ts` to replace ProviderConfig with simple agent string
2. Simplify `CommitMessageGeneratorConfig` schema (remove providerChain, provider fields)
3. Update generator constructor to accept `agent?: string` instead of complex config
4. Remove auto-detection logic from generator
5. Remove provider chain/fallback logic from generator
6. Update generator to instantiate agents directly (no factory)
7. Simplify error handling (no fallback attempts)
8. Update all TSDoc and examples
9. Update/fix all affected tests
10. Verify 80%+ coverage maintained

**Acceptance Criteria**:

- [ ] GeneratorConfig schema has â‰¤5 fields (down from ~15)
- [ ] No references to providerChain, ProviderConfig, or auto-detect
- [ ] Generator directly instantiates Claude or Codex agent
- [ ] No fallback logic exists in generator
- [ ] All error messages are actionable (what, why, how-to-fix)
- [ ] Tests pass with 80%+ coverage maintained

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/__tests__/generator.test.ts
pnpm test src/types/__tests__/schemas.test.ts
```

---

## Phase 4: Error Consolidation

**Strategy**: Sequential
**Reason**: Modifies files from Phase 2 (agents) and Phase 3 (generator)

### Task 5: Consolidate Error System

**Files**:

- src/errors.ts
- src/agents/claude.ts
- src/agents/codex.ts
- src/generator.ts
- src/__tests__/errors.test.ts

**Complexity**: M (4h)

**Dependencies**: Tasks 2, 3, 4 (shares src/agents/*.ts, src/generator.ts)

**Description**:

Replace 5+ provider error types with 2 consolidated error classes: `AgentError` (agent execution failed) and `GeneratorError` (generation failed). Delete `src/providers/errors.ts` and create new `src/errors.ts`. Update all agents and generator to use new error types. Ensure all error messages follow actionable format: what failed, why it failed, how to fix.

**Implementation Steps**:

1. Create `src/errors.ts` with `AgentError` and `GeneratorError` classes
2. Each error class includes `cause`, `context`, and `suggestedAction` fields
3. Update `src/agents/claude.ts` to throw `AgentError` with actionable messages
4. Update `src/agents/codex.ts` to throw `AgentError` with actionable messages
5. Update `src/generator.ts` to throw `GeneratorError` with actionable messages
6. Add error message templates for common scenarios (CLI not found, no changes, etc.)
7. Add comprehensive TSDoc with examples
8. Write unit tests for error creation and message formatting
9. Delete `src/providers/errors.ts`

**Acceptance Criteria**:

- [ ] Only 2 error classes exist: AgentError and GeneratorError
- [ ] All errors include actionable messages (what, why, how-to-fix)
- [ ] CLI not found errors show installation instructions
- [ ] No staged changes error shows `git add` example
- [ ] src/providers/errors.ts is deleted
- [ ] Tests achieve 80%+ coverage for error cases

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/__tests__/errors.test.ts
pnpm test src/__tests__/integration/error-messages.test.ts
```

---

## Phase 5: CLI Simplification

**Strategy**: Sequential
**Reason**: Depends on simplified generator (Phase 3) and new error system (Phase 4)

### Task 6: CLI Simplification & Dependency Cleanup

**Files**:

- src/cli.ts
- src/cli/schemas.ts
- src/cli/__tests__/schemas.test.ts
- package.json

**Complexity**: L (5h)

**Dependencies**: Tasks 4, 5 (shares src/generator.ts, needs errors)

**Description**:

Simplify CLI to â‰¤5 flags, remove auto-detection/fallback flags, merge list-providers and check-provider commands into main help text. Remove ora spinner dependency and replace with simple chalk status messages. Delete command modules (list-providers, check-provider, auto-detect) and inline essential logic. Reduce CLI complexity from ~15 flags to â‰¤5 core flags.

**Implementation Steps**:

1. Update `src/cli/schemas.ts` to remove provider chain/auto-detect flags
2. Reduce CLI flags to core 5: `--agent`, `--no-ai`, `--dry-run`, `--message-only`, `--cwd`
3. Delete `src/cli/commands/list-providers.ts`
4. Delete `src/cli/commands/check-provider.ts`
5. Delete `src/cli/commands/auto-detect.ts`
6. Merge useful info from deleted commands into `--help` text
7. Remove ora dependency from package.json
8. Replace all ora spinners with simple chalk status messages
9. Update CLI help text to show available agents inline
10. Update/fix all affected tests
11. Verify all integration tests pass

**Acceptance Criteria**:

- [ ] CLI has exactly â‰¤5 flags (--agent, --no-ai, --dry-run, --message-only, --cwd)
- [ ] ora dependency removed from package.json
- [ ] All command modules deleted (list-providers, check-provider, auto-detect)
- [ ] --help text includes available agents inline
- [ ] All status messages use chalk instead of ora
- [ ] Tests pass with 80%+ coverage maintained

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test src/cli/__tests__/schemas.test.ts
pnpm test src/__tests__/integration/validation.test.ts
```

---

## Phase 6: Final Integration

**Strategy**: Sequential
**Reason**: Depends on all previous phases, performs final cleanup and public API reduction

### Task 7: Public API Reduction & Documentation

**Files**:

- src/index.ts
- README.md
- CLAUDE.md
- package.json

**Complexity**: M (4h)

**Dependencies**: All previous tasks (final integration)

**Description**:

Reduce public API exports from ~30 to â‰¤10 items. Remove all chopstack references from README, docs, and comments. Update README with quick start guide (â‰¤3 commands). Update CLAUDE.md contributing guide to explain adding new agents. Delete all deprecated provider files and tests. Verify final LOC is ~2,000 (80% reduction from ~12,400).

**Implementation Steps**:

1. Update `src/index.ts` to export only core API (â‰¤10 items)
2. Remove all Provider-related exports
3. Export only: CommitMessageGenerator, CommitTask, Agent types, errors
4. Search and remove all "chopstack" references from codebase
5. Update README.md with quick start (install, configure, run)
6. Update README.md to remove provider chain/auto-detect documentation
7. Update CLAUDE.md with simplified agent addition guide
8. Delete deprecated provider files and tests:
   - src/providers/auto-detect.ts + tests
   - src/providers/provider-chain.ts + tests
   - src/providers/provider-factory.ts + tests
   - src/providers/base/base-cli-provider.ts + tests
   - src/providers/base/base-api-provider.ts + tests
   - src/providers/utils/cli-executor.ts + tests
   - src/providers/utils/cli-response-parser.ts + tests
9. Run LOC counter to verify ~2,000 total (80% reduction)
10. Run full test suite to verify no regressions

**Acceptance Criteria**:

- [ ] src/index.ts exports â‰¤10 items (down from ~30)
- [ ] All chopstack references removed from codebase
- [ ] README has quick start section (â‰¤3 commands to get started)
- [ ] CLAUDE.md has agent addition guide
- [ ] All deprecated provider files deleted (9 files + tests)
- [ ] Total LOC reduced to ~2,000 (80% reduction verified)
- [ ] All tests pass with 80%+ coverage maintained

**Mandatory Patterns**:

> **Constitution**: All code must follow @docs/constitutions/current/
>
> See architecture.md for layer boundaries and patterns.md for required patterns.

**TDD**: Follow `test-driven-development` skill (write test first, watch fail, minimal code, watch pass)

**Quality Gates**:

```bash
pnpm run lint
pnpm test
pnpm run build
# Verify LOC
find src -name '*.ts' -not -path '*/node_modules/*' -not -path '*/__tests__/*' | xargs wc -l
```

---

## Final Verification

After completing all phases, verify acceptance criteria from spec:

**Constitution Compliance:**

- [ ] All patterns followed (kebab-case files, camelCase functions, PascalCase types)
- [ ] Zod schema-first validation at boundaries
- [ ] Explicit return types, no `any` types
- [ ] TSDoc on all exports
- [ ] Architecture boundaries respected (CLI â†’ Generator â†’ Agent)
- [ ] Testing requirements met (80%+ coverage)

**Simplification Metrics:**

- [ ] Total LOC reduced by 80%+ (target: ~2,000 from ~12,400)
- [ ] Public API exports â‰¤10 (from ~30)
- [ ] CLI flags â‰¤5 (from ~15)
- [ ] Dependencies reduced (ora removed)
- [ ] Zero base classes or factories

**Quality Improvements:**

- [ ] All chopstack references removed
- [ ] All error messages actionable
- [ ] README has quick start
- [ ] Contributing guide explains adding agents
- [ ] All tests pass

**Feature Verification:**

- [ ] `commitment --agent claude` generates and commits message
- [ ] `commitment --agent codex` generates and commits message
- [ ] `commitment --no-ai` falls back to rule-based generation
- [ ] `commitment --dry-run` shows message without committing
- [ ] `commitment --message-only` outputs message only
- [ ] Error when CLI not found shows installation instructions
- [ ] Error when no staged changes shows `git add` example
